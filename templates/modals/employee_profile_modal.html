<!-- Employee Profile Modal -->
<div class="cad-modal-overlay" onclick="CAD_MODAL.close()"></div>
<div class="cad-modal emp-profile-modal" role="dialog" aria-modal="true" aria-label="Employee Profile">
    <div class="cad-modal-header">
        <div class="cad-modal-title">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Employee Profile
        </div>
        <button class="cad-modal-close" onclick="CAD_MODAL.close()">&times;</button>
    </div>
    <div class="cad-modal-body">
        <div class="emp-profile-container">
            <!-- Profile Header -->
            <div class="emp-profile-header" id="emp-profile-header">
                <div class="emp-headshot" id="emp-headshot">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div class="emp-header-info">
                    <div class="emp-display-name" id="emp-display-name">Loading...</div>
                    <div class="emp-unit-badge" id="emp-unit-badge">{{ unit_id }}</div>
                    <div class="emp-shift-info" id="emp-shift-info"></div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="emp-tabs">
                <button class="emp-tab active" data-tab="info" onclick="EMP_PROFILE.switchTab('info')">Info</button>
                <button class="emp-tab" data-tab="emergency" onclick="EMP_PROFILE.switchTab('emergency')">Emergency Contacts</button>
                <button class="emp-tab" data-tab="certs" onclick="EMP_PROFILE.switchTab('certs')">Certifications</button>
                <button class="emp-tab" data-tab="activity" onclick="EMP_PROFILE.switchTab('activity')">Dispatch History</button>
            </div>

            <!-- Info Tab -->
            <div class="emp-tab-content" id="emp-tab-info">
                <div class="emp-section">
                    <div class="emp-section-title">Personal Information</div>
                    <div class="emp-form-grid" id="emp-info-view">
                        <div class="emp-field"><label>Rank</label><span id="emp-rank">—</span></div>
                        <div class="emp-field"><label>Employee #</label><span id="emp-number">—</span></div>
                        <div class="emp-field"><label>Hire Date</label><span id="emp-hire-date">—</span></div>
                        <div class="emp-field"><label>Date of Birth</label><span id="emp-dob">—</span></div>
                        <div class="emp-field"><label>Blood Type</label><span id="emp-blood-type">—</span></div>
                        <div class="emp-field"><label>Unit Type</label><span id="emp-unit-type">—</span></div>
                    </div>
                </div>
                <div class="emp-section">
                    <div class="emp-section-title">Contact</div>
                    <div class="emp-form-grid" id="emp-contact-view">
                        <div class="emp-field">
                            <label>Phone</label>
                            <div class="emp-contact-row">
                                <span id="emp-phone">—</span>
                                <a id="emp-phone-sms" class="emp-action-btn" href="#" title="Send Text" style="display:none">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"></path></svg>
                                    Text
                                </a>
                            </div>
                        </div>
                        <div class="emp-field">
                            <label>Email</label>
                            <div class="emp-contact-row">
                                <span id="emp-email">—</span>
                                <a id="emp-email-link" class="emp-action-btn" href="#" title="Send Email" style="display:none">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                                    Email
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="emp-section">
                    <div class="emp-section-title">Address</div>
                    <div class="emp-address-view" id="emp-address-view">
                        <span id="emp-address">—</span>
                    </div>
                </div>
                <div class="emp-section">
                    <div class="emp-section-title">Notes</div>
                    <div class="emp-notes-view" id="emp-notes-view">
                        <span id="emp-notes">—</span>
                    </div>
                </div>

                <!-- Edit Form (hidden by default) -->
                <div id="emp-info-edit" style="display:none">
                    <div class="emp-section">
                        <div class="emp-section-title">Personal Information</div>
                        <div class="emp-form-grid">
                            <div class="emp-field"><label>Rank</label><input type="text" id="ef-rank" placeholder="e.g. Lieutenant"></div>
                            <div class="emp-field"><label>Employee #</label><input type="text" id="ef-number" placeholder="Employee number"></div>
                            <div class="emp-field"><label>Hire Date</label><input type="date" id="ef-hire-date"></div>
                            <div class="emp-field"><label>Date of Birth</label><input type="date" id="ef-dob"></div>
                            <div class="emp-field">
                                <label>Blood Type</label>
                                <select id="ef-blood-type">
                                    <option value="">—</option>
                                    <option value="A+">A+</option><option value="A-">A-</option>
                                    <option value="B+">B+</option><option value="B-">B-</option>
                                    <option value="AB+">AB+</option><option value="AB-">AB-</option>
                                    <option value="O+">O+</option><option value="O-">O-</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="emp-section">
                        <div class="emp-section-title">Contact</div>
                        <div class="emp-form-grid">
                            <div class="emp-field"><label>Phone</label><input type="tel" id="ef-phone" placeholder="Personal phone"></div>
                            <div class="emp-field"><label>Email</label><input type="email" id="ef-email" placeholder="Personal email"></div>
                        </div>
                    </div>
                    <div class="emp-section">
                        <div class="emp-section-title">Address</div>
                        <div class="emp-form-grid">
                            <div class="emp-field emp-full-width"><label>Line 1</label><input type="text" id="ef-addr1" placeholder="Street address"></div>
                            <div class="emp-field emp-full-width"><label>Line 2</label><input type="text" id="ef-addr2" placeholder="Apt, suite, etc."></div>
                            <div class="emp-field"><label>City</label><input type="text" id="ef-city"></div>
                            <div class="emp-field"><label>State</label><input type="text" id="ef-state" maxlength="2" placeholder="XX"></div>
                            <div class="emp-field"><label>ZIP</label><input type="text" id="ef-zip" maxlength="10"></div>
                        </div>
                    </div>
                    <div class="emp-section">
                        <div class="emp-section-title">Notes</div>
                        <textarea id="ef-notes" rows="3" placeholder="Additional notes..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Emergency Contacts Tab -->
            <div class="emp-tab-content" id="emp-tab-emergency" style="display:none">
                <div id="ec-list" class="ec-list">
                    <div class="search-loading">Loading...</div>
                </div>
                <div id="ec-form" style="display:none" class="ec-form">
                    <div class="emp-section-title" id="ec-form-title">Add Emergency Contact</div>
                    <input type="hidden" id="ec-edit-id" value="">
                    <div class="emp-form-grid">
                        <div class="emp-field"><label>Name *</label><input type="text" id="ec-name" required></div>
                        <div class="emp-field"><label>Relationship</label><input type="text" id="ec-relationship" placeholder="e.g. Spouse"></div>
                        <div class="emp-field"><label>Phone *</label><input type="tel" id="ec-phone" required></div>
                        <div class="emp-field"><label>Email</label><input type="email" id="ec-email"></div>
                        <div class="emp-field">
                            <label><input type="checkbox" id="ec-primary"> Primary Contact</label>
                        </div>
                    </div>
                    <div class="emp-form-actions">
                        <button class="btn-primary" onclick="EMP_PROFILE.saveContact()">Save</button>
                        <button class="btn-secondary" onclick="EMP_PROFILE.cancelContact()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Certifications Tab -->
            <div class="emp-tab-content" id="emp-tab-certs" style="display:none">
                <div id="cert-list" class="cert-list">
                    <div class="search-loading">Loading...</div>
                </div>
                <div id="cert-form" style="display:none" class="cert-form">
                    <div class="emp-section-title" id="cert-form-title">Add Certification</div>
                    <input type="hidden" id="cert-edit-id" value="">
                    <div class="emp-form-grid">
                        <div class="emp-field"><label>Certification *</label><input type="text" id="cert-name" required placeholder="e.g. EMT-P"></div>
                        <div class="emp-field"><label>Issuing Authority</label><input type="text" id="cert-authority" placeholder="e.g. NREMT"></div>
                        <div class="emp-field"><label>Cert Number</label><input type="text" id="cert-number"></div>
                        <div class="emp-field"><label>Issue Date</label><input type="date" id="cert-issue"></div>
                        <div class="emp-field"><label>Expiration Date</label><input type="date" id="cert-expire"></div>
                        <div class="emp-field">
                            <label>Status</label>
                            <select id="cert-status">
                                <option value="ACTIVE">Active</option>
                                <option value="EXPIRED">Expired</option>
                            </select>
                        </div>
                        <div class="emp-field emp-full-width"><label>Notes</label><input type="text" id="cert-notes" placeholder="Optional notes"></div>
                    </div>
                    <div class="emp-form-actions">
                        <button class="btn-primary" onclick="EMP_PROFILE.saveCert()">Save</button>
                        <button class="btn-secondary" onclick="EMP_PROFILE.cancelCert()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Activity Tab -->
            <div class="emp-tab-content" id="emp-tab-activity" style="display:none">
                <div id="activity-list">
                    <div class="emp-empty">Select the Activity tab to load recent dispatch history.</div>
                </div>
            </div>
        </div>
    </div>
    <div class="cad-modal-footer">
        <button class="btn-primary" id="emp-edit-btn" onclick="EMP_PROFILE.toggleEdit()">Edit Profile</button>
        <button class="btn-primary" id="emp-add-ec-btn" style="display:none" onclick="EMP_PROFILE.showAddContact()">+ Add Contact</button>
        <button class="btn-primary" id="emp-add-cert-btn" style="display:none" onclick="EMP_PROFILE.showAddCert()">+ Add Certification</button>
        <button class="btn-secondary" onclick="CAD_MODAL.close()">Close</button>
    </div>
</div>

<style>
.emp-profile-modal { min-width: 640px; max-width: 780px; max-height: 85vh; }
.emp-profile-container { display: flex; flex-direction: column; gap: var(--space-3); }

.emp-profile-header {
    display: flex; align-items: center; gap: var(--space-4);
    padding: var(--space-3); background: var(--bg-elevated);
    border-radius: var(--radius-md); border: 1px solid var(--border-light);
}
.emp-headshot {
    width: 80px; height: 80px; border-radius: 50%; overflow: hidden;
    border: 2px solid var(--border-default); flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    background: var(--bg-surface); color: var(--text-muted);
}
.emp-headshot img { width: 100%; height: 100%; object-fit: cover; }
.emp-header-info { display: flex; flex-direction: column; gap: 2px; }
.emp-display-name { font-size: 1.3em; font-weight: 700; color: var(--text-primary); }
.emp-unit-badge {
    display: inline-block; padding: 2px 10px; background: var(--ford-blue);
    color: #fff; border-radius: var(--radius-full); font-size: var(--text-sm); font-weight: 600; width: fit-content;
}
.emp-shift-info { font-size: var(--text-sm); color: var(--text-secondary); }

.emp-tabs { display: flex; gap: var(--space-1); border-bottom: 1px solid var(--border-default); padding-bottom: var(--space-2); }
.emp-tab {
    padding: var(--space-2) var(--space-3); background: transparent; border: none;
    color: var(--text-secondary); font-weight: 600; cursor: pointer;
    border-radius: var(--radius-md) var(--radius-md) 0 0;
}
.emp-tab.active { background: var(--bg-elevated); color: var(--ford-blue); }
.emp-tab:hover { color: var(--text-primary); }

.emp-tab-content { max-height: 400px; overflow-y: auto; }
.emp-section { margin-bottom: var(--space-3); }
.emp-section-title { font-weight: 700; font-size: var(--text-sm); text-transform: uppercase; color: var(--text-secondary); margin-bottom: var(--space-2); }
.emp-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-2); }
.emp-full-width { grid-column: 1 / -1; }

.emp-field { display: flex; flex-direction: column; gap: 2px; }
.emp-field label { font-size: var(--text-xs); font-weight: 600; color: var(--text-secondary); text-transform: uppercase; }
.emp-field span { font-size: var(--text-sm); color: var(--text-primary); padding: 4px 0; }
.emp-field input, .emp-field select {
    padding: var(--space-2); background: var(--bg-surface); border: 1px solid var(--border-default);
    border-radius: var(--radius-md); color: var(--text-primary); font-size: var(--text-sm);
}
.emp-field input[type="checkbox"] { width: auto; margin-right: 4px; }
.emp-tab-content textarea {
    width: 100%; padding: var(--space-2); background: var(--bg-surface);
    border: 1px solid var(--border-default); border-radius: var(--radius-md);
    color: var(--text-primary); font-size: var(--text-sm); resize: vertical;
}
.emp-contact-row { display: flex; align-items: center; gap: var(--space-2); }
.emp-action-btn {
    display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px;
    background: var(--ford-blue); color: #fff; border-radius: var(--radius-full);
    font-size: var(--text-xs); font-weight: 600; text-decoration: none; cursor: pointer;
    white-space: nowrap;
}
.emp-action-btn:hover { opacity: 0.85; }
.emp-address-view, .emp-notes-view { font-size: var(--text-sm); color: var(--text-primary); padding: 4px 0; }
.emp-form-actions { display: flex; gap: var(--space-2); justify-content: flex-end; margin-top: var(--space-2); }

/* Emergency Contact Cards */
.ec-list { display: flex; flex-direction: column; gap: var(--space-2); }
.ec-card {
    padding: var(--space-3); background: var(--bg-elevated); border: 1px solid var(--border-light);
    border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: flex-start;
}
.ec-card-info { flex: 1; }
.ec-card-name { font-weight: 700; color: var(--text-primary); }
.ec-card-relationship { font-size: var(--text-sm); color: var(--text-secondary); }
.ec-card-detail { font-size: var(--text-sm); color: var(--text-primary); margin-top: 2px; }
.ec-card-actions { display: flex; gap: var(--space-1); }
.ec-primary-badge {
    display: inline-block; padding: 1px 6px; background: var(--success-bg); color: var(--success);
    border-radius: var(--radius-full); font-size: var(--text-xs); font-weight: 600; margin-left: 6px;
}
.ec-form, .cert-form {
    padding: var(--space-3); background: var(--bg-elevated); border: 1px solid var(--ford-blue);
    border-radius: var(--radius-md); margin-top: var(--space-2);
}

/* Certification Table */
.cert-table { width: 100%; border-collapse: collapse; }
.cert-table th, .cert-table td { padding: var(--space-2); text-align: left; border-bottom: 1px solid var(--border-light); }
.cert-table th { font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; color: var(--text-secondary); }
.cert-badge {
    display: inline-block; padding: 2px 8px; border-radius: var(--radius-full);
    font-size: var(--text-xs); font-weight: 600;
}
.cert-badge.active { background: #22c55e20; color: #22c55e; }
.cert-badge.expired { background: #ef444420; color: #ef4444; }
.emp-empty { text-align: center; padding: var(--space-4); color: var(--text-muted); }

/* Activity Table */
.activity-table { width: 100%; border-collapse: collapse; }
.activity-table th, .activity-table td { padding: var(--space-2); text-align: left; border-bottom: 1px solid var(--border-light); font-size: var(--text-sm); }
.activity-table th { font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; color: var(--text-secondary); }
.activity-table td { color: var(--text-primary); }
.activity-priority { display: inline-block; padding: 1px 6px; border-radius: var(--radius-full); font-size: var(--text-xs); font-weight: 600; }
.activity-priority.p1 { background: #ef444420; color: #ef4444; }
.activity-priority.p2 { background: #f9731620; color: #f97316; }
.activity-priority.p3 { background: #eab30820; color: #eab308; }
.activity-priority.p4 { background: #22c55e20; color: #22c55e; }
</style>

<script>
window.EMP_PROFILE = (() => {
    const UNIT_ID = '{{ unit_id }}';
    const IS_ADMIN = {{ 'true' if is_admin else 'false' }};
    const IS_OWN = {{ 'true' if is_own_profile else 'false' }};
    const CAN_EDIT = IS_ADMIN || IS_OWN;
    let profileData = {};
    let editing = false;
    let activeTab = 'info';

    function esc(s) { const d = document.createElement('div'); d.textContent = String(s || ''); return d.innerHTML; }

    async function loadProfile() {
        try {
            const res = await fetch(`/api/employees/${encodeURIComponent(UNIT_ID)}`);
            const data = await res.json();
            if (!data.ok) { document.getElementById('emp-display-name').textContent = 'Error loading profile'; return; }
            profileData = data.profile;
            renderHeader();
            renderInfo();
        } catch(e) { document.getElementById('emp-display-name').textContent = 'Error loading profile'; }
    }

    function renderHeader() {
        const p = profileData;
        document.getElementById('emp-display-name').textContent = p.display_name || p.unit_id;
        document.getElementById('emp-unit-badge').textContent = p.unit_id + (p.rank ? ' — ' + p.rank : '');
        const shiftParts = [];
        if (p.shift_letter) shiftParts.push(p.shift_letter + ' Shift');
        if (p.status) shiftParts.push(p.status);
        if (p.current_incident) shiftParts.push('Assigned: #' + p.current_incident);
        document.getElementById('emp-shift-info').textContent = shiftParts.join(' • ') || '';

        if (p.headshot) {
            document.getElementById('emp-headshot').innerHTML = `<img src="${esc(p.headshot)}" alt="">`;
        }

        if (!CAN_EDIT) document.getElementById('emp-edit-btn').style.display = 'none';
    }

    function renderInfo() {
        const p = profileData;
        document.getElementById('emp-rank').textContent = p.rank || '—';
        document.getElementById('emp-number').textContent = p.employee_number || '—';
        document.getElementById('emp-hire-date').textContent = p.hire_date || '—';
        document.getElementById('emp-dob').textContent = p.dob || '—';
        document.getElementById('emp-blood-type').textContent = p.blood_type || '—';
        document.getElementById('emp-unit-type').textContent = p.unit_type || '—';
        document.getElementById('emp-phone').textContent = p.personal_phone || '—';
        document.getElementById('emp-email').textContent = p.personal_email || '—';

        // Wire action buttons for phone/email
        const smsBtn = document.getElementById('emp-phone-sms');
        const emailBtn = document.getElementById('emp-email-link');
        if (smsBtn) {
            if (p.personal_phone) { smsBtn.href = 'sms:' + p.personal_phone; smsBtn.style.display = ''; }
            else { smsBtn.style.display = 'none'; }
        }
        if (emailBtn) {
            if (p.personal_email) { emailBtn.href = 'mailto:' + p.personal_email; emailBtn.style.display = ''; }
            else { emailBtn.style.display = 'none'; }
        }

        const addrParts = [p.address_line1, p.address_line2, [p.address_city, p.address_state].filter(Boolean).join(', '), p.address_zip].filter(Boolean);
        document.getElementById('emp-address').textContent = addrParts.join(', ') || '—';
        document.getElementById('emp-notes').textContent = p.notes || '—';
    }

    function populateEditForm() {
        const p = profileData;
        document.getElementById('ef-rank').value = p.rank || '';
        document.getElementById('ef-number').value = p.employee_number || '';
        document.getElementById('ef-hire-date').value = p.hire_date || '';
        document.getElementById('ef-dob').value = p.dob || '';
        document.getElementById('ef-blood-type').value = p.blood_type || '';
        document.getElementById('ef-phone').value = p.personal_phone || '';
        document.getElementById('ef-email').value = p.personal_email || '';
        document.getElementById('ef-addr1').value = p.address_line1 || '';
        document.getElementById('ef-addr2').value = p.address_line2 || '';
        document.getElementById('ef-city').value = p.address_city || '';
        document.getElementById('ef-state').value = p.address_state || '';
        document.getElementById('ef-zip').value = p.address_zip || '';
        document.getElementById('ef-notes').value = p.notes || '';
    }

    async function saveProfile() {
        const payload = {
            rank: document.getElementById('ef-rank').value.trim(),
            employee_number: document.getElementById('ef-number').value.trim(),
            hire_date: document.getElementById('ef-hire-date').value,
            dob: document.getElementById('ef-dob').value,
            blood_type: document.getElementById('ef-blood-type').value,
            personal_phone: document.getElementById('ef-phone').value.trim(),
            personal_email: document.getElementById('ef-email').value.trim(),
            address_line1: document.getElementById('ef-addr1').value.trim(),
            address_line2: document.getElementById('ef-addr2').value.trim(),
            address_city: document.getElementById('ef-city').value.trim(),
            address_state: document.getElementById('ef-state').value.trim(),
            address_zip: document.getElementById('ef-zip').value.trim(),
            notes: document.getElementById('ef-notes').value.trim(),
        };
        try {
            const res = await fetch(`/api/employees/${encodeURIComponent(UNIT_ID)}`, {
                method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.ok) {
                TOAST?.success?.('Profile saved');
                editing = false;
                await loadProfile();
                document.getElementById('emp-info-view').style.display = '';
                document.getElementById('emp-info-edit').style.display = 'none';
                document.querySelectorAll('#emp-tab-info > .emp-section').forEach(s => s.style.display = '');
                document.getElementById('emp-edit-btn').textContent = 'Edit Profile';
            } else { TOAST?.error?.(data.error || 'Failed to save'); }
        } catch(e) { TOAST?.error?.('Error saving profile'); }
    }

    // --- Emergency Contacts ---
    async function loadContacts() {
        const listEl = document.getElementById('ec-list');
        try {
            const res = await fetch(`/api/employees/${encodeURIComponent(UNIT_ID)}/emergency_contacts`);
            const data = await res.json();
            if (!data.ok) { listEl.innerHTML = '<div class="emp-empty">Failed to load contacts</div>'; return; }
            if (data.contacts.length === 0) { listEl.innerHTML = '<div class="emp-empty">No emergency contacts</div>'; return; }
            let html = '';
            for (const c of data.contacts) {
                html += `<div class="ec-card">
                    <div class="ec-card-info">
                        <div class="ec-card-name">${esc(c.name)}${c.is_primary ? '<span class="ec-primary-badge">Primary</span>' : ''}</div>
                        <div class="ec-card-relationship">${esc(c.relationship || '')}</div>
                        <div class="ec-card-detail">${esc(c.phone || '')}${c.email ? ' • ' + esc(c.email) : ''}</div>
                    </div>
                    ${CAN_EDIT ? `<div class="ec-card-actions">
                        <button class="btn-icon" title="Edit" onclick="EMP_PROFILE.editContact(${c.id})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.85 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                        </button>
                        <button class="btn-icon danger" title="Delete" onclick="EMP_PROFILE.deleteContact(${c.id})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"></polyline><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path></svg>
                        </button>
                    </div>` : ''}
                </div>`;
            }
            listEl.innerHTML = html;
            // Store for editing
            listEl._data = data.contacts;
        } catch(e) { listEl.innerHTML = '<div class="emp-empty">Error loading contacts</div>'; }
    }

    function showAddContact() {
        document.getElementById('ec-form').style.display = 'block';
        document.getElementById('ec-form-title').textContent = 'Add Emergency Contact';
        document.getElementById('ec-edit-id').value = '';
        document.getElementById('ec-name').value = '';
        document.getElementById('ec-relationship').value = '';
        document.getElementById('ec-phone').value = '';
        document.getElementById('ec-email').value = '';
        document.getElementById('ec-primary').checked = false;
    }

    function editContact(id) {
        const contacts = document.getElementById('ec-list')._data || [];
        const c = contacts.find(x => x.id === id);
        if (!c) return;
        document.getElementById('ec-form').style.display = 'block';
        document.getElementById('ec-form-title').textContent = 'Edit Emergency Contact';
        document.getElementById('ec-edit-id').value = id;
        document.getElementById('ec-name').value = c.name || '';
        document.getElementById('ec-relationship').value = c.relationship || '';
        document.getElementById('ec-phone').value = c.phone || '';
        document.getElementById('ec-email').value = c.email || '';
        document.getElementById('ec-primary').checked = !!c.is_primary;
    }

    async function saveContact() {
        const name = document.getElementById('ec-name').value.trim();
        const phone = document.getElementById('ec-phone').value.trim();
        if (!name || !phone) { TOAST?.warning?.('Name and phone are required'); return; }
        const editId = document.getElementById('ec-edit-id').value;
        const payload = {
            name, phone,
            relationship: document.getElementById('ec-relationship').value.trim(),
            email: document.getElementById('ec-email').value.trim(),
            is_primary: document.getElementById('ec-primary').checked ? 1 : 0,
        };
        try {
            const url = editId
                ? `/api/employees/${encodeURIComponent(UNIT_ID)}/emergency_contacts/${editId}`
                : `/api/employees/${encodeURIComponent(UNIT_ID)}/emergency_contacts`;
            const method = editId ? 'PUT' : 'POST';
            const res = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            const data = await res.json();
            if (data.ok) {
                TOAST?.success?.(editId ? 'Contact updated' : 'Contact added');
                document.getElementById('ec-form').style.display = 'none';
                loadContacts();
            } else { TOAST?.error?.(data.error || 'Failed to save'); }
        } catch(e) { TOAST?.error?.('Error saving contact'); }
    }

    async function deleteContact(id) {
        if (!confirm('Delete this emergency contact?')) return;
        try {
            const res = await fetch(`/api/employees/${encodeURIComponent(UNIT_ID)}/emergency_contacts/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.ok) { TOAST?.success?.('Contact removed'); loadContacts(); }
            else { TOAST?.error?.(data.error || 'Failed to delete'); }
        } catch(e) { TOAST?.error?.('Error deleting contact'); }
    }

    // --- Certifications ---
    async function loadCerts() {
        const listEl = document.getElementById('cert-list');
        try {
            const res = await fetch(`/api/employees/${encodeURIComponent(UNIT_ID)}/certifications`);
            const data = await res.json();
            if (!data.ok) { listEl.innerHTML = '<div class="emp-empty">Failed to load certifications</div>'; return; }
            if (data.certifications.length === 0) { listEl.innerHTML = '<div class="emp-empty">No certifications</div>'; return; }
            let html = `<table class="cert-table"><thead><tr>
                <th>Certification</th><th>Authority</th><th>Number</th><th>Issued</th><th>Expires</th><th>Status</th>${CAN_EDIT ? '<th>Actions</th>' : ''}
            </tr></thead><tbody>`;
            for (const c of data.certifications) {
                const st = (c.status || 'ACTIVE').toUpperCase();
                const badge = st === 'ACTIVE' ? 'active' : 'expired';
                html += `<tr>
                    <td><strong>${esc(c.cert_name)}</strong></td>
                    <td>${esc(c.issuing_authority || '—')}</td>
                    <td>${esc(c.cert_number || '—')}</td>
                    <td>${esc(c.issue_date || '—')}</td>
                    <td>${esc(c.expiration_date || '—')}</td>
                    <td><span class="cert-badge ${badge}">${esc(st)}</span></td>
                    ${CAN_EDIT ? `<td>
                        <button class="btn-icon" title="Edit" onclick="EMP_PROFILE.editCert(${c.id})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.85 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                        </button>
                        <button class="btn-icon danger" title="Delete" onclick="EMP_PROFILE.deleteCert(${c.id})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"></polyline><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path></svg>
                        </button>
                    </td>` : ''}
                </tr>`;
            }
            html += '</tbody></table>';
            listEl.innerHTML = html;
            listEl._data = data.certifications;
        } catch(e) { listEl.innerHTML = '<div class="emp-empty">Error loading certifications</div>'; }
    }

    function showAddCert() {
        document.getElementById('cert-form').style.display = 'block';
        document.getElementById('cert-form-title').textContent = 'Add Certification';
        document.getElementById('cert-edit-id').value = '';
        document.getElementById('cert-name').value = '';
        document.getElementById('cert-authority').value = '';
        document.getElementById('cert-number').value = '';
        document.getElementById('cert-issue').value = '';
        document.getElementById('cert-expire').value = '';
        document.getElementById('cert-status').value = 'ACTIVE';
        document.getElementById('cert-notes').value = '';
    }

    function editCert(id) {
        const certs = document.getElementById('cert-list')._data || [];
        const c = certs.find(x => x.id === id);
        if (!c) return;
        document.getElementById('cert-form').style.display = 'block';
        document.getElementById('cert-form-title').textContent = 'Edit Certification';
        document.getElementById('cert-edit-id').value = id;
        document.getElementById('cert-name').value = c.cert_name || '';
        document.getElementById('cert-authority').value = c.issuing_authority || '';
        document.getElementById('cert-number').value = c.cert_number || '';
        document.getElementById('cert-issue').value = c.issue_date || '';
        document.getElementById('cert-expire').value = c.expiration_date || '';
        document.getElementById('cert-status').value = c.status || 'ACTIVE';
        document.getElementById('cert-notes').value = c.notes || '';
    }

    async function saveCert() {
        const certName = document.getElementById('cert-name').value.trim();
        if (!certName) { TOAST?.warning?.('Certification name is required'); return; }
        const editId = document.getElementById('cert-edit-id').value;
        const payload = {
            cert_name: certName,
            issuing_authority: document.getElementById('cert-authority').value.trim(),
            cert_number: document.getElementById('cert-number').value.trim(),
            issue_date: document.getElementById('cert-issue').value,
            expiration_date: document.getElementById('cert-expire').value,
            status: document.getElementById('cert-status').value,
            notes: document.getElementById('cert-notes').value.trim(),
        };
        try {
            const url = editId
                ? `/api/employees/${encodeURIComponent(UNIT_ID)}/certifications/${editId}`
                : `/api/employees/${encodeURIComponent(UNIT_ID)}/certifications`;
            const method = editId ? 'PUT' : 'POST';
            const res = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            const data = await res.json();
            if (data.ok) {
                TOAST?.success?.(editId ? 'Certification updated' : 'Certification added');
                document.getElementById('cert-form').style.display = 'none';
                loadCerts();
            } else { TOAST?.error?.(data.error || 'Failed to save'); }
        } catch(e) { TOAST?.error?.('Error saving certification'); }
    }

    async function deleteCert(id) {
        if (!confirm('Delete this certification?')) return;
        try {
            const res = await fetch(`/api/employees/${encodeURIComponent(UNIT_ID)}/certifications/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.ok) { TOAST?.success?.('Certification removed'); loadCerts(); }
            else { TOAST?.error?.(data.error || 'Failed to delete'); }
        } catch(e) { TOAST?.error?.('Error deleting certification'); }
    }

    // --- Activity ---
    async function loadActivity() {
        const listEl = document.getElementById('activity-list');
        listEl.innerHTML = '<div class="search-loading">Loading...</div>';
        try {
            const res = await fetch(`/api/employees/${encodeURIComponent(UNIT_ID)}/activity`);
            const data = await res.json();
            if (!data.ok) { listEl.innerHTML = '<div class="emp-empty">Failed to load activity</div>'; return; }
            if (!data.activity || data.activity.length === 0) {
                listEl.innerHTML = '<div class="emp-empty">No recent activity</div>'; return;
            }
            let html = `<table class="activity-table"><thead><tr>
                <th>Incident</th><th>Type</th><th>Location</th><th>Priority</th><th>Assigned</th><th>Enroute</th><th>Arrived</th><th>Cleared</th>
            </tr></thead><tbody>`;
            for (const a of data.activity) {
                const pClass = a.priority ? 'p' + String(a.priority).charAt(0) : '';
                const fmtTime = (t) => t ? t.replace(/T/, ' ').slice(0, 16) : '—';
                html += `<tr>
                    <td><strong>#${esc(a.incident_id || '—')}</strong></td>
                    <td>${esc(a.type || '—')}</td>
                    <td>${esc(a.location || '—')}</td>
                    <td>${a.priority ? '<span class="activity-priority ' + pClass + '">' + esc(a.priority) + '</span>' : '—'}</td>
                    <td>${fmtTime(a.assigned)}</td>
                    <td>${fmtTime(a.enroute)}</td>
                    <td>${fmtTime(a.arrived)}</td>
                    <td>${fmtTime(a.cleared)}</td>
                </tr>`;
            }
            html += '</tbody></table>';
            listEl.innerHTML = html;
        } catch(e) { listEl.innerHTML = '<div class="emp-empty">Error loading activity</div>'; }
    }

    // --- Tab switching ---
    function switchTab(tab) {
        activeTab = tab;
        document.querySelectorAll('.emp-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
        document.getElementById('emp-tab-info').style.display = tab === 'info' ? '' : 'none';
        document.getElementById('emp-tab-emergency').style.display = tab === 'emergency' ? '' : 'none';
        document.getElementById('emp-tab-certs').style.display = tab === 'certs' ? '' : 'none';
        document.getElementById('emp-tab-activity').style.display = tab === 'activity' ? '' : 'none';

        document.getElementById('emp-edit-btn').style.display = (tab === 'info' && CAN_EDIT) ? '' : 'none';
        document.getElementById('emp-add-ec-btn').style.display = (tab === 'emergency' && CAN_EDIT) ? '' : 'none';
        document.getElementById('emp-add-cert-btn').style.display = (tab === 'certs' && CAN_EDIT) ? '' : 'none';

        if (tab === 'emergency') loadContacts();
        if (tab === 'certs') loadCerts();
        if (tab === 'activity') loadActivity();
    }

    function toggleEdit() {
        if (!editing) {
            editing = true;
            populateEditForm();
            document.getElementById('emp-info-view').style.display = 'none';
            document.querySelectorAll('#emp-tab-info > .emp-section').forEach(s => s.style.display = 'none');
            document.getElementById('emp-info-edit').style.display = '';
            document.getElementById('emp-edit-btn').textContent = 'Save Profile';
        } else {
            saveProfile();
        }
    }

    // Init
    loadProfile();

    return {
        switchTab, toggleEdit,
        showAddContact, editContact, saveContact, deleteContact,
        cancelContact() { document.getElementById('ec-form').style.display = 'none'; },
        showAddCert, editCert, saveCert, deleteCert,
        cancelCert() { document.getElementById('cert-form').style.display = 'none'; },
    };
})();
</script>
