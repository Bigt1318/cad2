<!-- Report Confirmation Modal -->
<div id="report-confirm-modal" class="modal-overlay" style="display:none;">
  <div class="modal-box" style="max-width:480px;">
    <div class="modal-header" style="background:linear-gradient(135deg,#1e40af,#3b82f6);">
      <h2 style="margin:0;color:#fff;font-size:18px;">Report Ready to Send</h2>
    </div>

    <div class="modal-body" style="padding:20px;">
      <!-- Countdown Circle -->
      <div style="display:flex;justify-content:center;margin-bottom:20px;">
        <div id="report-countdown-circle" style="
          width:80px;height:80px;
          border-radius:50%;
          border:4px solid #e5e7eb;
          border-top-color:#1e40af;
          display:flex;align-items:center;justify-content:center;
          font-size:28px;font-weight:700;color:#1e40af;
          animation: countdown-pulse 1s ease-in-out infinite;
        ">
          <span id="report-countdown-seconds">30</span>
        </div>
      </div>

      <style>
        @keyframes countdown-pulse {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.05); }
        }
      </style>

      <!-- Report Info -->
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:15px;margin-bottom:16px;">
        <div style="display:grid;grid-template-columns:auto 1fr;gap:8px 16px;font-size:14px;">
          <span style="color:#64748b;font-weight:500;">Shift:</span>
          <span id="report-confirm-shift" style="font-weight:600;">A Shift</span>

          <span style="color:#64748b;font-weight:500;">Type:</span>
          <span id="report-confirm-type" style="font-weight:600;">Interim Report</span>

          <span style="color:#64748b;font-weight:500;">Incidents:</span>
          <span id="report-confirm-incidents" style="font-weight:600;">0</span>

          <span style="color:#64748b;font-weight:500;">Issues:</span>
          <span id="report-confirm-issues" style="font-weight:600;">0</span>

          <span style="color:#64748b;font-weight:500;">Recipients:</span>
          <span id="report-confirm-recipients" style="font-weight:600;font-size:12px;">Battalion Chiefs 1-4</span>
        </div>
      </div>

      <p style="text-align:center;color:#64748b;font-size:13px;margin:0 0 20px;">
        Report will auto-send when countdown reaches zero.
      </p>

      <!-- Action Buttons -->
      <div style="display:flex;gap:12px;justify-content:center;">
        <button id="report-confirm-cancel" class="btn btn-secondary" style="min-width:120px;">
          Cancel
        </button>
        <button id="report-confirm-send" class="btn btn-primary" style="min-width:120px;background:#16a34a;border-color:#16a34a;">
          Send Now
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const modal = document.getElementById('report-confirm-modal');
  const countdownEl = document.getElementById('report-countdown-seconds');
  const circleEl = document.getElementById('report-countdown-circle');
  const sendBtn = document.getElementById('report-confirm-send');
  const cancelBtn = document.getElementById('report-confirm-cancel');

  let pollInterval = null;
  let lastPendingId = null;

  // Start polling for pending reports
  function startPolling() {
    if (pollInterval) return;
    pollInterval = setInterval(checkPendingReport, 2000);
    checkPendingReport(); // Check immediately
  }

  // Stop polling
  function stopPolling() {
    if (pollInterval) {
      clearInterval(pollInterval);
      pollInterval = null;
    }
  }

  // Check for pending reports
  async function checkPendingReport() {
    try {
      const resp = await fetch('/api/reports/pending');
      const data = await resp.json();

      if (data.pending && data.report && data.report.status === 'pending') {
        // New pending report or update existing
        if (data.report.id !== lastPendingId) {
          lastPendingId = data.report.id;
          showModal(data.report);
          // Play alert sound
          playAlertSound();
        }
        updateCountdown(data.report.remaining_seconds);
      } else if (data.report && data.report.status !== 'pending') {
        // Report was handled (sent, cancelled, etc.)
        hideModal();
        lastPendingId = null;
      } else {
        // No pending report
        hideModal();
        lastPendingId = null;
      }
    } catch (e) {
      console.warn('[ReportConfirm] Poll error:', e);
    }
  }

  // Show the modal with report details
  function showModal(report) {
    document.getElementById('report-confirm-shift').textContent = report.shift + ' Shift';
    document.getElementById('report-confirm-type').textContent =
      report.report_type === 'interim' ? 'Interim Report' : 'End of Shift Report';
    document.getElementById('report-confirm-incidents').textContent =
      report.stats?.total_incidents || 0;
    document.getElementById('report-confirm-issues').textContent =
      report.stats?.issues_found || 0;
    document.getElementById('report-confirm-recipients').textContent =
      'Battalion Chiefs 1-4';

    modal.style.display = 'flex';
  }

  // Hide the modal
  function hideModal() {
    modal.style.display = 'none';
  }

  // Update countdown display
  function updateCountdown(seconds) {
    countdownEl.textContent = Math.max(0, seconds);

    // Change color as time runs out
    if (seconds <= 10) {
      circleEl.style.borderTopColor = '#dc2626';
      countdownEl.style.color = '#dc2626';
    } else {
      circleEl.style.borderTopColor = '#1e40af';
      countdownEl.style.color = '#1e40af';
    }
  }

  // Play alert sound
  function playAlertSound() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = 880;
      osc.type = 'sine';
      gain.gain.value = 0.3;
      osc.start();
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
      osc.stop(ctx.currentTime + 0.5);
    } catch (e) {
      // Audio not supported
    }
  }

  // Confirm (send now)
  sendBtn.addEventListener('click', async () => {
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';

    try {
      const resp = await fetch('/api/reports/pending/confirm', { method: 'POST' });
      const data = await resp.json();

      if (data.ok) {
        window.TOAST?.success?.('Report sent to Battalion Chiefs');
      } else {
        window.TOAST?.error?.(data.error || 'Failed to send report');
      }
    } catch (e) {
      window.TOAST?.error?.('Failed to send report');
    }

    sendBtn.disabled = false;
    sendBtn.textContent = 'Send Now';
    hideModal();
    lastPendingId = null;
  });

  // Cancel
  cancelBtn.addEventListener('click', async () => {
    cancelBtn.disabled = true;
    cancelBtn.textContent = 'Cancelling...';

    try {
      const resp = await fetch('/api/reports/pending/cancel', { method: 'POST' });
      const data = await resp.json();

      if (data.ok) {
        window.TOAST?.info?.('Report cancelled');
      } else {
        window.TOAST?.error?.(data.error || 'Failed to cancel');
      }
    } catch (e) {
      window.TOAST?.error?.('Failed to cancel report');
    }

    cancelBtn.disabled = false;
    cancelBtn.textContent = 'Cancel';
    hideModal();
    lastPendingId = null;
  });

  // Close on overlay click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      // Don't close - require explicit action
    }
  });

  // Start polling when page loads
  startPolling();

  // Manual send report function
  async function triggerManualReport() {
    try {
      const resp = await fetch('/api/reports/pending/create', { method: 'POST' });
      const data = await resp.json();

      if (data.ok) {
        window.TOAST?.info?.('Report ready - confirm to send');
        checkPendingReport(); // Check immediately to show modal
      } else {
        window.TOAST?.error?.(data.error || 'Failed to create report');
      }
    } catch (e) {
      window.TOAST?.error?.('Failed to create report');
    }
  }

  // Expose for external control
  window.ReportConfirm = {
    startPolling,
    stopPolling,
    checkPendingReport,
    triggerManualReport
  };

  // Hook up the Send Report button
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('btn-reports') || document.getElementById('btn-send-report');
    if (btn) {
      btn.addEventListener('click', triggerManualReport);
    }
  });
})();
</script>
