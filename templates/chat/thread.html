<!-- ============================================================================
     FORD-CAD Chat Thread â€” Channel Message View
     Used inside drawer and in incident IAW chat embed
     ============================================================================ -->

<div class="chat-thread" data-channel-id="{{ channel.id }}">
    <!-- THREAD HEADER -->
    <div class="chat-thread-header">
        <button class="chat-icon-btn" onclick="MessagingUI.closeThread()" title="Back">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
        </button>
        <div class="chat-thread-title">
            {% if channel.type == 'dm' and other_name %}
                <span class="chat-presence-dot" data-user="{{ other_name }}"
                      data-status="{{ presence.get(other_name, {}).get('status', 'offline') }}"></span>
                {{ other_name }}
            {% elif channel.title %}
                {% if channel.type == 'incident' %}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--fire-red)">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                {% elif channel.type == 'shift' %}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--ford-blue)">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                {% elif channel.type == 'ops' %}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 3h-8l-2 4h12z"/>
                    </svg>
                {% endif %}
                {{ channel.title }}
            {% else %}
                Channel #{{ channel.id }}
            {% endif %}
        </div>
        <div class="chat-thread-meta">
            {% if channel.type != 'dm' %}
                <span class="chat-member-count">{{ members|length }} members</span>
            {% endif %}
            <button class="chat-icon-btn" onclick="MessagingUI.showChannelInfo({{ channel.id }})" title="Channel info">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/>
                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- MESSAGE LIST -->
    <div class="chat-messages" id="chat-msg-list" onscroll="MessagingUI.onScroll(this)">
        {% if messages|length == 50 %}
        <div class="chat-load-more">
            <button class="chat-action-btn" onclick="MessagingUI.loadMore({{ channel.id }}, {{ messages[0].id }})">
                Load earlier messages
            </button>
        </div>
        {% endif %}

        {% set prev_date = namespace(val='') %}
        {% for msg in messages %}
            {% set msg_date = msg.created_at[:10] %}
            {% if msg_date != prev_date.val %}
                <div class="chat-date-divider">
                    <span>{{ msg_date }}</span>
                </div>
                {% set prev_date.val = msg_date %}
            {% endif %}

            {% set is_mine = msg.sender_id == user_id %}
            {% set is_system = msg.sender_type == 'system' %}

            {% if is_system %}
            <!-- SYSTEM CARD -->
            <div class="chat-msg chat-msg-system" data-msg-id="{{ msg.id }}">
                {% if msg.msg_type.startswith('card:') %}
                    {% set card_type = msg.msg_type.replace('card:', '') %}
                    <div class="chat-card chat-card-{{ card_type }}"
                         {% if card_type == 'status' %}
                             {% set ev = msg.metadata.get('event', '') %}
                             {% if ev in ['ARRIVED', 'CLEAR'] %}style="border-left-color: var(--status-available)"
                             {% elif ev in ['ENROUTE'] %}style="border-left-color: var(--status-enroute)"
                             {% elif ev in ['DISPATCH', 'DISPATCHED'] %}style="border-left-color: var(--status-dispatched)"
                             {% elif ev in ['HOLD'] %}style="border-left-color: var(--fire-amber)"
                             {% else %}style="border-left-color: var(--ford-blue)"
                             {% endif %}
                         {% elif card_type == 'safety' %}style="border-left-color: var(--fire-red)"
                         {% elif card_type == 'incident' %}style="border-left-color: var(--ford-blue)"
                         {% elif card_type == 'resource' %}style="border-left-color: var(--fire-orange)"
                         {% endif %}>
                        <div class="chat-card-body">{{ msg.body }}</div>
                        <div class="chat-card-time">{{ msg.created_at[11:16] }}</div>
                    </div>
                {% else %}
                    <div class="chat-system-text">{{ msg.body }}</div>
                {% endif %}
            </div>
            {% else %}
            <!-- USER MESSAGE -->
            <div class="chat-msg {% if is_mine %}chat-msg-mine{% else %}chat-msg-other{% endif %} {% if msg.priority == 'urgent' %}chat-msg-urgent{% elif msg.priority == 'emergency' %}chat-msg-emergency{% endif %}"
                 data-msg-id="{{ msg.id }}"
                 oncontextmenu="MessagingUI.showContextMenu(event, {{ msg.id }}, {{ 'true' if is_mine else 'false' }})">

                {% if not is_mine and channel.type != 'dm' %}
                <div class="chat-msg-sender">{{ msg.sender_name or msg.sender_id }}</div>
                {% endif %}

                <div class="chat-bubble {% if is_mine %}chat-bubble-mine{% else %}chat-bubble-other{% endif %}">
                    {% if msg.reply_to_id %}
                    <div class="chat-reply-ref" onclick="MessagingUI.scrollToMessage({{ msg.reply_to_id }})">
                        Reply to #{{ msg.reply_to_id }}
                    </div>
                    {% endif %}

                    <div class="chat-msg-body">{{ msg.body }}</div>

                    {% if msg.edited_at %}
                    <span class="chat-edited-label">(edited)</span>
                    {% endif %}

                    <div class="chat-msg-footer">
                        <span class="chat-msg-time">{{ msg.created_at[11:16] }}</span>
                        {% if msg.priority == 'urgent' %}
                            <span class="chat-priority-tag urgent">URGENT</span>
                        {% elif msg.priority == 'emergency' %}
                            <span class="chat-priority-tag emergency">EMERGENCY</span>
                        {% endif %}
                        {% if msg.require_ack and not is_mine %}
                            <button class="chat-ack-btn" onclick="MessagingUI.ackMessage({{ msg.id }})" title="Acknowledge">
                                ACK
                            </button>
                        {% endif %}
                    </div>
                </div>

                {% if is_mine %}
                <button class="chat-msg-delete-btn" onclick="MessagingUI.deleteMessageDirect({{ msg.id }})" title="Delete message">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/>
                        <path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"/>
                    </svg>
                </button>
                {% endif %}

                <!-- REACTIONS -->
                {% if msg.reactions %}
                <div class="chat-reactions">
                    {% for r in msg.reactions %}
                    <button class="chat-reaction-pill {% if user_id in r.users %}chat-reaction-mine{% endif %}"
                            onclick="MessagingUI.toggleReaction({{ msg.id }}, '{{ r.reaction }}')">
                        {{ r.reaction }} {{ r.count }}
                    </button>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- QUICK REACT BAR (shown on hover) -->
                <div class="chat-quick-react">
                    <button onclick="MessagingUI.toggleReaction({{ msg.id }}, 'ack')" title="Acknowledged">&#10003;</button>
                    <button onclick="MessagingUI.toggleReaction({{ msg.id }}, 'thumbs_up')" title="Affirmative">&#128077;</button>
                    <button onclick="MessagingUI.toggleReaction({{ msg.id }}, 'alert')" title="Attention">&#9888;</button>
                    <button onclick="MessagingUI.toggleReaction({{ msg.id }}, 'enroute')" title="En route">&#128659;</button>
                    <button onclick="MessagingUI.toggleReaction({{ msg.id }}, 'complete')" title="Complete">&#9989;</button>
                    <button onclick="MessagingUI.toggleReaction({{ msg.id }}, 'question')" title="Need clarification">&#10067;</button>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- TYPING INDICATOR -->
    <div id="chat-typing" class="chat-typing" style="display:none">
        <span class="chat-typing-dots"><span></span><span></span><span></span></span>
        <span id="chat-typing-who"></span> is typing...
    </div>

    <!-- REPLY PREVIEW (shown when replying to a message) -->
    <div id="chat-reply-preview" style="display:none" class="chat-reply-preview">
        <span class="reply-label">Replying to</span>
        <span id="chat-reply-text" class="reply-text"></span>
        <button onclick="MessagingUI.cancelReply()" class="reply-cancel">&times;</button>
    </div>

    <!-- COMPOSER -->
    <div class="chat-composer">
        {% if is_dispatcher %}
        <div class="chat-quick-replies">
            <button class="chat-quick-reply" onclick="MessagingUI.insertQuickReply('Copy')">Copy</button>
            <button class="chat-quick-reply" onclick="MessagingUI.insertQuickReply('10-4')">10-4</button>
            <button class="chat-quick-reply" onclick="MessagingUI.insertQuickReply('Enroute?')">Enroute?</button>
            <button class="chat-quick-reply" onclick="MessagingUI.insertQuickReply('ETA?')">ETA?</button>
            <button class="chat-quick-reply" onclick="MessagingUI.insertQuickReply('Stage at...')">Stage</button>
            <button class="chat-quick-reply" onclick="MessagingUI.insertQuickReply('Hold traffic')">Hold Traffic</button>
        </div>
        {% endif %}

        <!-- @Mention autocomplete dropdown -->
        <div id="chat-mention-dropdown" class="chat-mention-dropdown" style="display:none"></div>

        <div class="chat-composer-row">
            <button class="chat-icon-btn" onclick="document.getElementById('chat-file-input').click()" title="Attach file">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
                </svg>
            </button>
            <input type="file" id="chat-file-input" style="display:none" onchange="MessagingUI.handleFileSelect(this)">

            <textarea id="chat-input" class="chat-textarea" rows="1" placeholder="Type a message... (@ to mention)"
                      oninput="MessagingUI.handleComposerInput(this)"
                      onkeydown="MessagingUI.handleKeyDown(event, {{ channel.id }})"></textarea>

            <select id="chat-priority-select" class="chat-priority-select" title="Message priority">
                <option value="normal">Normal</option>
                <option value="urgent">Urgent</option>
                <option value="emergency">Emergency</option>
            </select>

            <button class="chat-send-btn" onclick="MessagingUI.sendFromComposer({{ channel.id }})" title="Send">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
            </button>
        </div>

        <!-- Pending attachments preview -->
        <div id="chat-pending-files" class="chat-pending-files" style="display:none"></div>
    </div>
</div>

<!-- CONTEXT MENU (positioned absolutely, hidden) -->
<div id="chat-context-menu" class="chat-context-menu" style="display:none">
    <button data-action="edit" onclick="MessagingUI.editMessage()">Edit</button>
    <button data-action="delete" onclick="MessagingUI.deleteMessage()">Delete</button>
    <button data-action="reply" onclick="MessagingUI.replyToMessage()">Reply</button>
</div>

<script>
// Apply @mention highlighting to server-rendered messages
(function() {
    document.querySelectorAll('.chat-msg-body').forEach(function(el) {
        var text = el.innerHTML;
        if (text.indexOf('@') !== -1) {
            el.innerHTML = text.replace(/@([A-Za-z0-9_-]+)/g,
                '<span class="chat-mention" data-mention="$1">@$1</span>');
        }
    });
})();
</script>
