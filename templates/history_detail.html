<!-- ============================================================
     FORD-CAD â€” INCIDENT HISTORY DETAIL (MODAL)
     Phase-3 Canon
     ============================================================ -->

<div class="cad-modal-overlay" onclick="CAD_MODAL.close()"></div>

<div class="cad-modal history-detail-modal">
  <div class="cad-modal-body">

    <div class="history-detail">

      <div class="history-detail-header">
        <h2>Incident #{{ incident.incident_number or incident.incident_id }}</h2>

        <div style="display:flex; gap:8px; align-items:center;">
          {% if (incident.status or "")|upper == "CLOSED" %}
            <button class="pill-btn" type="button"
                    data-action="incident-reopen"
                    data-incident-id="{{ incident.incident_id }}">
              Reopen
            </button>
          {% endif %}

          <button class="pill-btn" type="button" onclick="CAD_MODAL.close()">Close</button>
        </div>
      </div>

      <div class="history-meta">
        <div><strong>Run:</strong> {{ incident.incident_number or "" }}</div>
        <div><strong>Date:</strong> {{ incident.incident_date }}</div>
        <div><strong>Time:</strong> {{ incident.incident_time }}</div>
        <div><strong>Type:</strong> {{ incident.type }}</div>
        <div><strong>Location:</strong> {{ incident.location }}</div>
        <div><strong>Status:</strong> {{ incident.status }}</div>
      </div>

      <h3>Narrative</h3>

      <div class="history-narrative">
        {% if narrative|length == 0 %}
          <div class="history-narrative-empty">No narrative entries.</div>
        {% else %}
          {% for n in narrative %}
            <div class="history-narrative-entry">
              <div class="history-narrative-header">
                <span>{{ n.timestamp }}</span>
                <span>{{ n.user }}</span>
              </div>
              <div class="history-narrative-text">{{ n.text }}</div>
            </div>
          {% endfor %}
        {% endif %}
      </div>

      <h3>Activity</h3>

      <div class="history-narrative">
        {% if events is not defined or events|length == 0 %}
          <div class="history-narrative-empty">No activity events.</div>
        {% else %}
          {% for e in events %}
            <div class="history-narrative-entry">
              <div class="history-narrative-header">
                <span>{{ e.timestamp }}</span>
                <span>{{ e.user or "" }}{% if e.unit_id %} ({{ e.unit_id }}){% endif %}</span>
              </div>
              <div class="history-narrative-text">
                <strong>{{ e.event_type }}</strong>{% if e.details %}: {{ e.details }}{% endif %}
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>

    </div>

  </div>
</div>
