<!-- Contacts Directory Modal — DB-Driven CRUD -->
<div class="cad-modal-overlay" onclick="CAD_MODAL.close()"></div>
<div class="cad-modal contacts-modal" role="dialog" aria-modal="true" aria-label="Contacts Directory">
    <div class="cad-modal-header">
        <div class="cad-modal-title">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            Contacts Directory
        </div>
        <button class="cad-modal-close" onclick="CAD_MODAL.close()">&times;</button>
    </div>
    <div class="cad-modal-body">
        <div class="contacts-container">
            <div class="contacts-search">
                <input type="text" placeholder="Search contacts..." id="contacts-search-input">
            </div>

            <div class="contacts-categories">
                <button class="cat-btn active" data-cat="all">All</button>
                <button class="cat-btn" data-cat="Fire">Fire</button>
                <button class="cat-btn" data-cat="EMS">EMS</button>
                <button class="cat-btn" data-cat="Police">Police</button>
                <button class="cat-btn" data-cat="Utilities">Utilities</button>
                <button class="cat-btn" data-cat="Hospital">Hospital</button>
            </div>

            <!-- Add/Edit Form (hidden by default) -->
            <div class="contact-form" id="contact-form" style="display:none">
                <div class="form-title" id="contact-form-title">Add Contact</div>
                <input type="hidden" id="cf-id" value="">
                <div class="form-row">
                    <input type="text" id="cf-name" placeholder="Name *" required>
                    <input type="text" id="cf-phone" placeholder="Phone">
                </div>
                <div class="form-row">
                    <input type="email" id="cf-email" placeholder="Email">
                    <select id="cf-role">
                        <option value="">— Category —</option>
                        <option value="Fire">Fire</option>
                        <option value="EMS">EMS</option>
                        <option value="Police">Police</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Hospital">Hospital</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-row">
                    <input type="text" id="cf-unit" placeholder="Unit ID (optional)">
                    <input type="text" id="cf-notes" placeholder="Notes / Signal #">
                </div>
                <div class="form-actions">
                    <button class="btn-primary" onclick="CONTACTS.saveForm()">Save</button>
                    <button class="btn-secondary" onclick="CONTACTS.cancelForm()">Cancel</button>
                </div>
            </div>

            <div class="contacts-list" id="contacts-list">
                <div class="search-loading">Loading contacts...</div>
            </div>
        </div>
    </div>
    <div class="cad-modal-footer">
        <button class="btn-primary" onclick="CONTACTS.showAddForm()">+ Add Contact</button>
        <button class="btn-secondary" onclick="CAD_MODAL.close()">Close</button>
    </div>
</div>

<style>
.contacts-modal { min-width: 540px; max-height: 80vh; }
.contacts-container { display: flex; flex-direction: column; gap: var(--space-3); }
.contacts-search input {
    width: 100%;
    padding: var(--space-2);
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    color: var(--text-primary);
}
.contacts-categories {
    display: flex;
    gap: var(--space-1);
    flex-wrap: wrap;
}
.cat-btn {
    padding: var(--space-1) var(--space-2);
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
}
.cat-btn.active, .cat-btn:hover {
    background: var(--ford-blue);
    color: white;
    border-color: var(--ford-blue);
}
.contact-form {
    padding: var(--space-3);
    background: var(--bg-elevated);
    border: 1px solid var(--ford-blue);
    border-radius: var(--radius-md);
}
.contact-form .form-title {
    font-weight: 700;
    margin-bottom: var(--space-2);
    color: var(--text-primary);
}
.contact-form .form-row {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
}
.contact-form .form-row input,
.contact-form .form-row select {
    flex: 1;
    padding: var(--space-2);
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: var(--text-sm);
}
.contact-form .form-actions {
    display: flex;
    gap: var(--space-2);
    justify-content: flex-end;
}
.contacts-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    max-height: 360px;
    overflow-y: auto;
}
.contact-card {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) var(--space-3);
    background: var(--bg-elevated);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
}
.contact-icon {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
    color: white;
    font-size: 11px;
    font-weight: 700;
    flex-shrink: 0;
}
.contact-icon.Fire { background: #ef4444; }
.contact-icon.EMS { background: #3b82f6; }
.contact-icon.Police { background: #6366f1; }
.contact-icon.Hospital { background: #22c55e; }
.contact-icon.Utilities { background: #f59e0b; }
.contact-icon.Other { background: #64748b; }
.contact-info { flex: 1; min-width: 0; }
.contact-name { font-weight: 600; color: var(--text-primary); }
.contact-detail { font-size: var(--text-sm); color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.contact-actions { display: flex; gap: var(--space-1); }
.btn-icon {
    padding: var(--space-1);
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: var(--radius-sm);
}
.btn-icon:hover { background: var(--bg-hover); color: var(--text-primary); }
.btn-icon.danger:hover { color: #ef4444; }
.contacts-empty {
    text-align: center;
    padding: var(--space-4);
    color: var(--text-muted);
}
</style>

<script>
window.CONTACTS = (() => {
    let allContacts = [];
    let activeCategory = 'all';

    async function loadContacts() {
        const listEl = document.getElementById('contacts-list');
        try {
            const res = await fetch('/api/contacts');
            const data = await res.json();
            if (data.ok) {
                allContacts = data.contacts || [];
                renderContacts();
            } else {
                listEl.innerHTML = '<div class="contacts-empty">Failed to load contacts</div>';
            }
        } catch (e) {
            listEl.innerHTML = '<div class="contacts-empty">Error loading contacts</div>';
        }
    }

    function renderContacts() {
        const listEl = document.getElementById('contacts-list');
        const searchVal = (document.getElementById('contacts-search-input')?.value || '').toLowerCase();

        let filtered = allContacts;
        if (activeCategory !== 'all') {
            filtered = filtered.filter(c => (c.role || '').toLowerCase() === activeCategory.toLowerCase());
        }
        if (searchVal) {
            filtered = filtered.filter(c =>
                (c.name || '').toLowerCase().includes(searchVal) ||
                (c.phone || '').toLowerCase().includes(searchVal) ||
                (c.email || '').toLowerCase().includes(searchVal)
            );
        }

        if (filtered.length === 0) {
            listEl.innerHTML = '<div class="contacts-empty">No contacts found</div>';
            return;
        }

        listEl.innerHTML = filtered.map(c => {
            const cat = c.role || 'Other';
            const detail = [c.phone, c.email].filter(Boolean).join(' | ');
            return `<div class="contact-card" data-id="${c.contact_id}" data-cat="${cat}">
                <div class="contact-icon ${cat}">${cat.substring(0,3).toUpperCase()}</div>
                <div class="contact-info">
                    <div class="contact-name">${esc(c.name || 'Unknown')}</div>
                    <div class="contact-detail">${esc(detail || 'No details')}</div>
                </div>
                <div class="contact-actions">
                    <button class="btn-icon" title="Edit" onclick="CONTACTS.editContact(${c.contact_id})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.85 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                    </button>
                    <button class="btn-icon danger" title="Delete" onclick="CONTACTS.deleteContact(${c.contact_id}, '${esc(c.name || '')}')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"></polyline><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path></svg>
                    </button>
                </div>
            </div>`;
        }).join('');
    }

    function esc(s) {
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    // Init: load contacts and wire events
    loadContacts();

    // Search filtering
    document.getElementById('contacts-search-input')?.addEventListener('input', () => renderContacts());

    // Category filtering
    document.querySelectorAll('.cat-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            activeCategory = btn.dataset.cat;
            renderContacts();
        });
    });

    return {
        showAddForm() {
            document.getElementById('contact-form').style.display = 'block';
            document.getElementById('contact-form-title').textContent = 'Add Contact';
            document.getElementById('cf-id').value = '';
            document.getElementById('cf-name').value = '';
            document.getElementById('cf-phone').value = '';
            document.getElementById('cf-email').value = '';
            document.getElementById('cf-role').value = '';
            document.getElementById('cf-unit').value = '';
            document.getElementById('cf-notes').value = '';
            document.getElementById('cf-name').focus();
        },

        cancelForm() {
            document.getElementById('contact-form').style.display = 'none';
        },

        editContact(id) {
            const c = allContacts.find(x => x.contact_id === id);
            if (!c) return;
            document.getElementById('contact-form').style.display = 'block';
            document.getElementById('contact-form-title').textContent = 'Edit Contact';
            document.getElementById('cf-id').value = c.contact_id;
            document.getElementById('cf-name').value = c.name || '';
            document.getElementById('cf-phone').value = c.phone || '';
            document.getElementById('cf-email').value = c.email || '';
            document.getElementById('cf-role').value = c.role || '';
            document.getElementById('cf-unit').value = c.unit_id || '';
            document.getElementById('cf-notes').value = c.signal_number || '';
        },

        async saveForm() {
            const id = document.getElementById('cf-id').value;
            const name = document.getElementById('cf-name').value.trim();
            if (!name) { TOAST?.warning?.('Name is required'); return; }

            const payload = {
                name,
                phone: document.getElementById('cf-phone').value.trim(),
                email: document.getElementById('cf-email').value.trim(),
                role: document.getElementById('cf-role').value,
                unit_id: document.getElementById('cf-unit').value.trim(),
                signal_number: document.getElementById('cf-notes').value.trim(),
            };

            try {
                const url = id ? `/api/contacts/${id}` : '/api/contacts';
                const method = id ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                if (data.ok) {
                    TOAST?.success?.(id ? 'Contact updated' : 'Contact added');
                    document.getElementById('contact-form').style.display = 'none';
                    loadContacts();
                } else {
                    TOAST?.error?.(data.error || 'Failed to save');
                }
            } catch (e) {
                TOAST?.error?.('Error saving contact');
            }
        },

        async deleteContact(id, name) {
            if (!confirm(`Delete contact "${name}"?`)) return;
            try {
                const res = await fetch(`/api/contacts/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.ok) {
                    TOAST?.success?.('Contact deleted');
                    loadContacts();
                } else {
                    TOAST?.error?.(data.error || 'Failed to delete');
                }
            } catch (e) {
                TOAST?.error?.('Error deleting contact');
            }
        },

        addNew() { this.showAddForm(); }
    };
})();
</script>
