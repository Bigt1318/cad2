<!-- Reports Admin Modal - Comprehensive Report Configuration -->
<div class="cad-modal-overlay" onclick="CAD_MODAL.close()"></div>
<div class="cad-modal reports-admin-modal" role="dialog" aria-modal="true" aria-label="Reports Admin">
    <div class="cad-modal-header">
        <div class="cad-modal-title">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                <polyline points="14,2 14,8 20,8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
            Reports Administration
        </div>
        <button class="cad-modal-close" onclick="CAD_MODAL.close()">&times;</button>
    </div>
    <div class="cad-modal-body">
        <div class="reports-admin-container">
            <!-- Tab Navigation -->
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="schedule">Schedule</button>
                <button class="admin-tab" data-tab="analytics">Analytics</button>
                <button class="admin-tab" data-tab="times">Report Times</button>
                <button class="admin-tab" data-tab="recipients">Recipients</button>
                <button class="admin-tab" data-tab="email">Email Settings</button>
                <button class="admin-tab" data-tab="schedules">Schedules</button>
            </div>

            <!-- TAB 1: REPORT SCHEDULE -->
            <div class="admin-tab-content active" id="admin-tab-schedule">
                <!-- Big Toggle -->
                <div class="toggle-section">
                    <div class="toggle-header">
                        <div class="toggle-title">Automatic Reports</div>
                        <div class="toggle-subtitle">Send end-of-shift reports automatically</div>
                    </div>
                    <label class="big-toggle">
                        <input type="checkbox" id="auto-report-toggle">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label-on">ON</span>
                        <span class="toggle-label-off">OFF</span>
                    </label>
                </div>

                <!-- Status Display -->
                <div class="status-section">
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-label">Scheduler Status</div>
                            <div class="status-value" id="scheduler-status">
                                <span class="status-dot"></span>
                                <span class="status-text">Loading...</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Next Report</div>
                            <div class="status-value" id="next-report-time">--</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Current Time</div>
                            <div class="status-value" id="current-time-display">--</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Timezone</div>
                            <div class="status-value" id="current-timezone">--</div>
                        </div>
                    </div>
                </div>

                <!-- Manual Send Section -->
                <div class="action-section">
                    <div class="section-title">Manual Actions</div>
                    <div class="action-buttons">
                        <button class="btn-action primary" onclick="REPORTS_ADMIN.sendReportNow()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path>
                            </svg>
                            Send Report Now
                        </button>
                        <button class="btn-action" onclick="REPORTS_ADMIN.previewReport()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            Preview Report
                        </button>
                    </div>
                </div>

                <!-- Startup Behavior -->
                <div class="option-section">
                    <label class="checkbox-option">
                        <input type="checkbox" id="auto-start-on-startup">
                        <span class="checkbox-label">
                            <strong>Start scheduler on server startup</strong>
                            <small>When enabled, reports will automatically start when the server restarts</small>
                        </span>
                    </label>
                </div>
            </div>

            <!-- TAB 6: ANALYTICS DASHBOARD -->
            <div class="admin-tab-content" id="admin-tab-analytics">
                <!-- Date Range Picker -->
                <div class="form-section">
                    <div class="section-title">Date Range</div>
                    <div class="analytics-date-row">
                        <select id="analytics-preset" class="form-select" style="max-width:180px;" onchange="REPORTS_ADMIN.onAnalyticsPresetChange()">
                            <option value="7d">Last 7 Days</option>
                            <option value="30d" selected>Last 30 Days</option>
                            <option value="90d">Last 90 Days</option>
                            <option value="mtd">Month to Date</option>
                            <option value="ytd">Year to Date</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <input type="date" id="analytics-start" class="form-input" style="max-width:160px;display:none;">
                        <input type="date" id="analytics-end" class="form-input" style="max-width:160px;display:none;">
                        <button class="btn-action primary" onclick="REPORTS_ADMIN.loadAnalytics()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"></path>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="analytics-kpi-row" id="analytics-kpis">
                    <div class="analytics-kpi-card">
                        <div class="analytics-kpi-value" id="kpi-total-incidents">--</div>
                        <div class="analytics-kpi-label">Total Incidents</div>
                    </div>
                    <div class="analytics-kpi-card">
                        <div class="analytics-kpi-value" id="kpi-avg-response">--</div>
                        <div class="analytics-kpi-label">Avg Response Time</div>
                    </div>
                    <div class="analytics-kpi-card">
                        <div class="analytics-kpi-value" id="kpi-p90-response">--</div>
                        <div class="analytics-kpi-label">90th Percentile</div>
                    </div>
                    <div class="analytics-kpi-card">
                        <div class="analytics-kpi-value" id="kpi-compliance">--</div>
                        <div class="analytics-kpi-label">Compliance %</div>
                    </div>
                    <div class="analytics-kpi-card">
                        <div class="analytics-kpi-value" id="kpi-active-units">--</div>
                        <div class="analytics-kpi-label">Active Units</div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="analytics-charts-grid">
                    <div class="analytics-chart-panel" style="grid-column: span 2;">
                        <div class="analytics-chart-title">Incident Trend</div>
                        <canvas id="analytics-trend-chart" height="200"></canvas>
                    </div>
                    <div class="analytics-chart-panel">
                        <div class="analytics-chart-title">Type Breakdown</div>
                        <canvas id="analytics-type-chart" height="220"></canvas>
                    </div>
                    <div class="analytics-chart-panel">
                        <div class="analytics-chart-title">Hourly Pattern</div>
                        <canvas id="analytics-hourly-chart" height="220"></canvas>
                    </div>
                </div>

                <!-- Generate Report Actions -->
                <div class="analytics-actions">
                    <div class="section-title">Generate Analytics Report</div>
                    <div class="analytics-action-row">
                        <select id="analytics-template" class="form-select" style="flex:1;">
                            <option value="executive_summary">Executive Summary Dashboard</option>
                            <option value="response_performance">Response Performance Analysis</option>
                            <option value="incident_analytics">Incident Analytics Report</option>
                            <option value="unit_performance">Unit Performance Dashboard</option>
                            <option value="department_overview">Department Overview Report</option>
                        </select>
                        <select id="analytics-format" class="form-select" style="max-width:100px;">
                            <option value="html">HTML</option>
                            <option value="pdf">PDF</option>
                            <option value="csv">CSV</option>
                            <option value="xlsx">XLSX</option>
                        </select>
                        <button class="btn-action primary" onclick="REPORTS_ADMIN.generateAnalyticsReport()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                                <polyline points="14,2 14,8 20,8"></polyline>
                            </svg>
                            Generate
                        </button>
                        <button class="btn-action" onclick="REPORTS_ADMIN.previewAnalyticsReport()">
                            Preview
                        </button>
                    </div>
                    <div class="analytics-action-row" style="margin-top:8px;">
                        <button class="btn-action" onclick="REPORTS_ADMIN.scheduleAnalyticsReport()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Schedule This Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- TAB 2: REPORT TIMES -->
            <div class="admin-tab-content" id="admin-tab-times">
                <div class="form-section">
                    <div class="section-title">Timezone Configuration</div>
                    <p class="section-desc">All report times are based on this timezone. Server may run in UTC.</p>
                    <div class="form-row">
                        <label>Timezone</label>
                        <select id="timezone-select" class="form-select">
                            <option value="America/New_York">Eastern Time (America/New_York)</option>
                            <option value="America/Chicago">Central Time (America/Chicago)</option>
                            <option value="America/Denver">Mountain Time (America/Denver)</option>
                            <option value="America/Los_Angeles">Pacific Time (America/Los_Angeles)</option>
                            <option value="America/Anchorage">Alaska Time (America/Anchorage)</option>
                            <option value="Pacific/Honolulu">Hawaii Time (Pacific/Honolulu)</option>
                            <option value="UTC">UTC</option>
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">Report Times</div>
                    <p class="section-desc">When to send end-of-shift reports (30 min before shift ends)</p>
                    <div class="form-row">
                        <label>Day Shift Report</label>
                        <input type="time" id="day-report-time" class="form-input" value="17:30">
                        <span class="time-hint">Default: 17:30 (5:30 PM)</span>
                    </div>
                    <div class="form-row">
                        <label>Night Shift Report</label>
                        <input type="time" id="night-report-time" class="form-input" value="05:30">
                        <span class="time-hint">Default: 05:30 (5:30 AM)</span>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn-primary" onclick="REPORTS_ADMIN.saveTimes()">Save Report Times</button>
                </div>
            </div>

            <!-- TAB 3: RECIPIENTS -->
            <div class="admin-tab-content" id="admin-tab-recipients">
                <div class="form-section">
                    <div class="section-title">Battalion Chief Emails</div>
                    <p class="section-desc">Reports are sent to the on-duty battalion chief</p>
                    <div id="bc-email-list" class="bc-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">Additional Recipients</div>
                    <p class="section-desc">These addresses receive ALL reports regardless of shift</p>
                    <textarea id="additional-recipients" class="form-textarea"
                        placeholder="email1@example.com&#10;email2@example.com"></textarea>
                    <button class="btn-primary" onclick="REPORTS_ADMIN.saveRecipients()" style="margin-top:8px;">
                        Save Recipients
                    </button>
                </div>
            </div>

            <!-- TAB 4: EMAIL SETTINGS -->
            <div class="admin-tab-content" id="admin-tab-email">
                <div class="form-section">
                    <div class="section-title">SendGrid Configuration</div>
                    <p class="section-desc">SendGrid is recommended for reliable email delivery</p>
                    <div class="form-row">
                        <label>API Key</label>
                        <input type="password" id="sendgrid-api-key" class="form-input"
                            placeholder="SG.xxxxxxxxxx">
                        <button class="btn-icon" onclick="REPORTS_ADMIN.togglePassword('sendgrid-api-key')" title="Show/Hide">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                    <div class="form-row">
                        <label>From Email</label>
                        <input type="email" id="from-email" class="form-input"
                            placeholder="noreply@yourdomain.com">
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" onclick="REPORTS_ADMIN.saveEmailConfig()">Save Email Config</button>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">Test Email</div>
                    <p class="section-desc">Send a test email to verify configuration</p>
                    <div class="form-row">
                        <label>Test Address</label>
                        <input type="email" id="test-email-address" class="form-input"
                            placeholder="your@email.com">
                        <button class="btn-action" onclick="REPORTS_ADMIN.sendTestEmail()">
                            Send Test
                        </button>
                    </div>
                </div>

                <div class="config-status" id="email-config-status">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- TAB 5: SCHEDULES (v3 CRUD) -->
            <div class="admin-tab-content" id="admin-tab-schedules">
                <!-- Create / Edit Schedule Form (collapsible) -->
                <div class="form-section">
                    <div class="sched-form-header" onclick="REPORTS_ADMIN.toggleSchedForm()">
                        <div class="section-title" style="margin-bottom:0;border-bottom:none;cursor:pointer;">
                            <span id="sched-form-title">+ Create New Schedule</span>
                        </div>
                    </div>
                    <div id="sched-form-panel" class="sched-form-panel" style="display:none;">
                        <input type="hidden" id="sched-edit-id" value="">
                        <div class="form-row">
                            <label>Name</label>
                            <input type="text" id="sched-name" class="form-input" placeholder="e.g. Daily Battalion Report">
                        </div>
                        <div class="form-row">
                            <label>Template</label>
                            <select id="sched-template" class="form-select">
                                <option value="">Loading templates...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Shift Filter</label>
                            <select id="sched-shift" class="form-select">
                                <option value="all">All Shifts</option>
                                <option value="A">A Shift</option>
                                <option value="B">B Shift</option>
                                <option value="C">C Shift</option>
                                <option value="D">D Shift</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Frequency</label>
                            <select id="sched-frequency" class="form-select" onchange="REPORTS_ADMIN.onFrequencyChange()">
                                <option value="shift_change">Shift Change</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="once">One-Time</option>
                            </select>
                        </div>

                        <!-- Conditional: Weekly day picker -->
                        <div class="form-row sched-cond sched-cond-weekly" style="display:none;">
                            <label>Day of Week</label>
                            <div class="sched-day-picker">
                                <label class="sched-day-chip"><input type="checkbox" value="0"> Sun</label>
                                <label class="sched-day-chip"><input type="checkbox" value="1"> Mon</label>
                                <label class="sched-day-chip"><input type="checkbox" value="2"> Tue</label>
                                <label class="sched-day-chip"><input type="checkbox" value="3"> Wed</label>
                                <label class="sched-day-chip"><input type="checkbox" value="4"> Thu</label>
                                <label class="sched-day-chip"><input type="checkbox" value="5"> Fri</label>
                                <label class="sched-day-chip"><input type="checkbox" value="6"> Sat</label>
                            </div>
                        </div>

                        <!-- Conditional: Monthly day-of-month -->
                        <div class="form-row sched-cond sched-cond-monthly" style="display:none;">
                            <label>Day of Month</label>
                            <input type="number" id="sched-day-of-month" class="form-input" min="1" max="31" value="1" style="max-width:100px;">
                        </div>

                        <!-- Conditional: One-time datetime -->
                        <div class="form-row sched-cond sched-cond-once" style="display:none;">
                            <label>Run At</label>
                            <input type="datetime-local" id="sched-run-at" class="form-input">
                        </div>

                        <!-- Delivery Channels -->
                        <div class="section-title" style="margin-top:var(--space-3);">Delivery Channels</div>
                        <div class="sched-channels">
                            <label class="checkbox-option sched-channel-opt">
                                <input type="checkbox" id="sched-ch-email" onchange="REPORTS_ADMIN.toggleChannel('email')">
                                <span class="checkbox-label">
                                    <strong>Email</strong>
                                    <small>Send report via email</small>
                                </span>
                            </label>
                            <div class="form-row sched-channel-detail" id="sched-ch-email-detail" style="display:none;">
                                <label>Email Address</label>
                                <input type="email" id="sched-email-addr" class="form-input" placeholder="recipient@example.com">
                            </div>

                            <label class="checkbox-option sched-channel-opt">
                                <input type="checkbox" id="sched-ch-sms" onchange="REPORTS_ADMIN.toggleChannel('sms')">
                                <span class="checkbox-label">
                                    <strong>SMS</strong>
                                    <small>Send report via text message</small>
                                </span>
                            </label>
                            <div class="form-row sched-channel-detail" id="sched-ch-sms-detail" style="display:none;">
                                <label>Phone Number</label>
                                <input type="tel" id="sched-sms-phone" class="form-input" placeholder="+15551234567">
                            </div>

                            <label class="checkbox-option sched-channel-opt">
                                <input type="checkbox" id="sched-ch-webhook" onchange="REPORTS_ADMIN.toggleChannel('webhook')">
                                <span class="checkbox-label">
                                    <strong>Webhook</strong>
                                    <small>POST report to a URL</small>
                                </span>
                            </label>
                            <div class="form-row sched-channel-detail" id="sched-ch-webhook-detail" style="display:none;">
                                <label>Webhook URL</label>
                                <input type="url" id="sched-webhook-url" class="form-input" placeholder="https://hooks.example.com/report">
                            </div>

                            <label class="checkbox-option sched-channel-opt">
                                <input type="checkbox" id="sched-ch-signal" onchange="REPORTS_ADMIN.toggleChannel('signal')">
                                <span class="checkbox-label">
                                    <strong>Signal</strong>
                                    <small>Send report via Signal messenger</small>
                                </span>
                            </label>
                            <div class="form-row sched-channel-detail" id="sched-ch-signal-detail" style="display:none;">
                                <label>Signal Number</label>
                                <input type="tel" id="sched-signal-phone" class="form-input" placeholder="+15551234567">
                            </div>

                            <label class="checkbox-option sched-channel-opt">
                                <input type="checkbox" id="sched-ch-webex" onchange="REPORTS_ADMIN.toggleChannel('webex')">
                                <span class="checkbox-label">
                                    <strong>Webex</strong>
                                    <small>Send report to Webex space</small>
                                </span>
                            </label>
                            <div class="form-row sched-channel-detail" id="sched-ch-webex-detail" style="display:none;">
                                <label>Webex Room ID</label>
                                <input type="text" id="sched-webex-room" class="form-input" placeholder="Room ID or email">
                            </div>
                        </div>

                        <!-- Output Format -->
                        <div class="section-title" style="margin-top:var(--space-3);">Output Format</div>
                        <div class="form-row">
                            <label>Format</label>
                            <select id="sched-format" class="form-select">
                                <option value="html" selected>HTML</option>
                                <option value="pdf">PDF</option>
                                <option value="csv">CSV</option>
                                <option value="xlsx">XLSX</option>
                            </select>
                        </div>

                        <div class="form-actions" style="display:flex;gap:8px;">
                            <button class="btn-primary" id="sched-submit-btn" onclick="REPORTS_ADMIN.saveSchedule()">Create Schedule</button>
                            <button class="btn-action" id="sched-cancel-btn" style="display:none;" onclick="REPORTS_ADMIN.cancelEditSchedule()">Cancel Edit</button>
                        </div>
                    </div>
                </div>

                <!-- Schedules Table -->
                <div class="form-section">
                    <div class="section-title">All Schedules</div>
                    <div id="sched-table-wrap" class="sched-table-wrap">
                        <table class="sched-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Template</th>
                                    <th>Frequency</th>
                                    <th>Enabled</th>
                                    <th>Next Run</th>
                                    <th>Last Run</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sched-table-body">
                                <tr><td colspan="7" class="sched-loading">Loading schedules...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="cad-modal-footer">
        <button class="btn-secondary" onclick="CAD_MODAL.close()">Close</button>
    </div>
</div>

<style>
.reports-admin-modal {
    min-width: 700px;
    max-width: 850px;
}

.reports-admin-container {
    padding: var(--space-2);
}

/* Tabs */
.admin-tabs {
    display: flex;
    gap: 4px;
    border-bottom: 2px solid var(--border-default);
    margin-bottom: var(--space-3);
}

.admin-tab {
    padding: 12px 20px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.15s;
}

.admin-tab:hover {
    color: var(--ford-blue);
    background: var(--bg-hover);
}

.admin-tab.active {
    color: var(--ford-blue);
    border-bottom-color: var(--ford-blue);
}

.admin-tab-content {
    display: none;
}

.admin-tab-content.active {
    display: block;
}

/* Big Toggle */
.toggle-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-4);
}

.toggle-header {
    flex: 1;
}

.toggle-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
}

.toggle-subtitle {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.big-toggle {
    position: relative;
    display: inline-flex;
    align-items: center;
    cursor: pointer;
}

.big-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: relative;
    width: 80px;
    height: 40px;
    background: #dc2626;
    border-radius: 20px;
    transition: 0.3s;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 32px;
    width: 32px;
    left: 4px;
    bottom: 4px;
    background: white;
    border-radius: 50%;
    transition: 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.big-toggle input:checked + .toggle-slider {
    background: #16a34a;
}

.big-toggle input:checked + .toggle-slider:before {
    transform: translateX(40px);
}

.toggle-label-on, .toggle-label-off {
    position: absolute;
    font-size: 11px;
    font-weight: 700;
    color: white;
    top: 50%;
    transform: translateY(-50%);
}

.toggle-label-on {
    left: 12px;
    opacity: 0;
}

.toggle-label-off {
    right: 12px;
}

.big-toggle input:checked ~ .toggle-label-on {
    opacity: 1;
}

.big-toggle input:checked ~ .toggle-label-off {
    opacity: 0;
}

/* Status Section */
.status-section {
    margin-bottom: var(--space-4);
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-3);
}

.status-item {
    background: var(--bg-subtle);
    padding: var(--space-3);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
}

.status-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

.status-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #9ca3af;
}

.status-dot.running {
    background: #16a34a;
    animation: pulse 2s infinite;
}

.status-dot.stopped {
    background: #dc2626;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Action Section */
.action-section {
    margin-bottom: var(--space-4);
}

.section-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--text-secondary);
    margin-bottom: var(--space-2);
    padding-bottom: var(--space-1);
    border-bottom: 1px solid var(--border-light);
}

.section-desc {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: var(--space-3);
}

.action-buttons {
    display: flex;
    gap: var(--space-2);
}

.btn-action {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.15s;
}

.btn-action:hover {
    background: var(--bg-active);
    border-color: var(--ford-blue);
}

.btn-action.primary {
    background: var(--ford-blue);
    border-color: var(--ford-blue);
    color: white;
}

.btn-action.primary:hover {
    background: #1e40af;
}

/* Option Section */
.option-section {
    margin-bottom: var(--space-3);
}

.checkbox-option {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: var(--space-3);
    background: var(--bg-subtle);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    cursor: pointer;
}

.checkbox-option input[type="checkbox"] {
    margin-top: 2px;
    width: 18px;
    height: 18px;
    accent-color: var(--ford-blue);
}

.checkbox-label {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.checkbox-label strong {
    font-size: 13px;
    color: var(--text-primary);
}

.checkbox-label small {
    font-size: 11px;
    color: var(--text-secondary);
}

/* Form Section */
.form-section {
    margin-bottom: var(--space-4);
}

.form-row {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
}

.form-row label {
    min-width: 120px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
}

.form-input, .form-select {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid var(--border-default);
    border-radius: var(--radius-sm);
    font-size: 13px;
    background: var(--bg-surface);
    color: var(--text-primary);
}

.form-input:focus, .form-select:focus {
    outline: none;
    border-color: var(--ford-blue);
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
}

.form-textarea {
    width: 100%;
    min-height: 80px;
    padding: 10px 12px;
    border: 1px solid var(--border-default);
    border-radius: var(--radius-sm);
    font-size: 13px;
    font-family: inherit;
    resize: vertical;
    background: var(--bg-surface);
    color: var(--text-primary);
}

.time-hint {
    font-size: 11px;
    color: var(--text-secondary);
}

.form-actions {
    margin-top: var(--space-3);
}

.btn-primary {
    padding: 10px 20px;
    background: var(--ford-blue);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
}

.btn-primary:hover {
    background: #1e40af;
}

.btn-icon {
    padding: 8px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-sm);
    cursor: pointer;
}

/* BC List */
.bc-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.bc-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--bg-subtle);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
}

.bc-shift {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--ford-blue);
    color: white;
    font-weight: 700;
    font-size: 16px;
    border-radius: var(--radius-md);
}

.bc-info {
    flex: 1;
}

.bc-name {
    font-weight: 600;
    font-size: 13px;
    color: var(--text-primary);
}

.bc-email-input {
    width: 100%;
    margin-top: 4px;
    padding: 6px 10px;
    border: 1px solid var(--border-default);
    border-radius: var(--radius-sm);
    font-size: 12px;
    background: var(--bg-surface);
}

.bc-test-btn {
    padding: 6px 12px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-sm);
    font-size: 11px;
    cursor: pointer;
}

.bc-test-btn:hover {
    background: var(--bg-active);
}

/* Config Status */
.config-status {
    padding: var(--space-3);
    background: var(--bg-subtle);
    border-radius: var(--radius-md);
    margin-top: var(--space-3);
}

.config-status-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 0;
    font-size: 13px;
}

.config-status-item .check {
    color: #16a34a;
}

.config-status-item .cross {
    color: #dc2626;
}

/* ---- Schedules Tab ---- */
.sched-form-header {
    cursor: pointer;
    user-select: none;
}

.sched-form-panel {
    padding-top: var(--space-2);
}

.sched-day-picker {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    flex: 1;
}

.sched-day-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border: 1px solid var(--border-default);
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    background: var(--bg-elevated);
    color: var(--text-primary);
    transition: all 0.15s;
}

.sched-day-chip:has(input:checked) {
    background: var(--ford-blue);
    color: white;
    border-color: var(--ford-blue);
}

.sched-day-chip input {
    display: none;
}

.sched-channels {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
}

.sched-channel-opt {
    margin-bottom: 0;
}

.sched-channel-detail {
    margin-left: 30px;
    margin-bottom: var(--space-2);
}

.sched-table-wrap {
    overflow-x: auto;
}

.sched-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.sched-table th {
    text-align: left;
    padding: 8px 10px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--text-secondary);
    border-bottom: 2px solid var(--border-default);
    white-space: nowrap;
}

.sched-table td {
    padding: 8px 10px;
    border-bottom: 1px solid var(--border-light);
    color: var(--text-primary);
    vertical-align: middle;
}

.sched-table tbody tr:hover {
    background: var(--bg-hover);
}

.sched-loading {
    text-align: center;
    color: var(--text-secondary);
    padding: 20px 10px !important;
}

.sched-empty {
    text-align: center;
    color: var(--text-secondary);
    padding: 20px 10px !important;
    font-style: italic;
}

.sched-actions {
    display: flex;
    gap: 4px;
    white-space: nowrap;
}

.sched-actions button {
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 600;
    border: 1px solid var(--border-default);
    border-radius: var(--radius-sm);
    cursor: pointer;
    background: var(--bg-elevated);
    color: var(--text-primary);
    transition: all 0.15s;
}

.sched-actions button:hover {
    border-color: var(--ford-blue);
    background: var(--bg-active);
}

.sched-actions button.sched-btn-run {
    color: #16a34a;
}

.sched-actions button.sched-btn-del {
    color: #dc2626;
}

.sched-actions button.sched-btn-del:hover {
    border-color: #dc2626;
    background: #fef2f2;
}

.sched-toggle-label {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 22px;
    cursor: pointer;
}

.sched-toggle-label input {
    opacity: 0;
    width: 0;
    height: 0;
}

.sched-toggle-slider {
    position: absolute;
    inset: 0;
    background: #dc2626;
    border-radius: 11px;
    transition: 0.25s;
}

.sched-toggle-slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 3px;
    bottom: 3px;
    background: white;
    border-radius: 50%;
    transition: 0.25s;
}

.sched-toggle-label input:checked + .sched-toggle-slider {
    background: #16a34a;
}

.sched-toggle-label input:checked + .sched-toggle-slider:before {
    transform: translateX(18px);
}

.sched-freq-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    background: var(--bg-subtle);
    border: 1px solid var(--border-light);
}

/* ---- Analytics Tab ---- */
.analytics-date-row {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}

.analytics-kpi-row {
    display: flex;
    gap: 10px;
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
}

.analytics-kpi-card {
    flex: 1;
    min-width: 110px;
    padding: 14px 10px;
    text-align: center;
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    transition: border-color 0.2s;
}

.analytics-kpi-card:hover {
    border-color: var(--ford-blue);
}

.analytics-kpi-value {
    font-size: 22px;
    font-weight: 800;
    color: var(--ford-blue);
    line-height: 1.1;
}

.analytics-kpi-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-secondary);
    margin-top: 4px;
    letter-spacing: 0.3px;
}

.analytics-charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 14px;
    margin-bottom: var(--space-4);
}

.analytics-chart-panel {
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    padding: 14px;
    overflow: hidden;
}

.analytics-chart-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--text-secondary);
    margin-bottom: 10px;
}

.analytics-actions {
    margin-top: var(--space-3);
}

.analytics-action-row {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}
</style>

<script>
window.REPORTS_ADMIN = {
    config: null,

    init() {
        // Tab switching
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('admin-tab-' + tab.dataset.tab)?.classList.add('active');

                // Lazy-load data when tabs are activated
                if (tab.dataset.tab === 'schedules') {
                    this.loadSchedules();
                    this.loadSchedTemplates();
                } else if (tab.dataset.tab === 'analytics') {
                    this.loadAnalytics();
                }
            });
        });

        // Toggle event
        document.getElementById('auto-report-toggle')?.addEventListener('change', (e) => {
            this.toggleAutoReport(e.target.checked);
        });

        // Startup checkbox event
        document.getElementById('auto-start-on-startup')?.addEventListener('change', (e) => {
            this.setStartupBehavior(e.target.checked);
        });

        // Load all data
        this.loadStatus();
        this.loadBCEmails();
        this.loadRecipients();
        this.loadEmailConfig();
    },

    async loadStatus() {
        try {
            const res = await fetch('/api/reports/scheduler/status');
            const data = await res.json();
            this.config = data;

            // Update toggle
            document.getElementById('auto-report-toggle').checked = data.enabled;

            // Update status display
            const statusEl = document.getElementById('scheduler-status');
            const dot = statusEl.querySelector('.status-dot');
            const text = statusEl.querySelector('.status-text');

            if (data.running) {
                dot.className = 'status-dot running';
                text.textContent = 'Running';
            } else {
                dot.className = 'status-dot stopped';
                text.textContent = 'Stopped';
            }

            // Update other status fields
            document.getElementById('next-report-time').textContent = data.next_report_time || '--';
            document.getElementById('current-time-display').textContent = data.current_time || '--';
            document.getElementById('current-timezone').textContent = data.timezone || '--';

            // Update startup checkbox
            document.getElementById('auto-start-on-startup').checked = data.auto_report_on_startup;

            // Update times tab
            document.getElementById('timezone-select').value = data.timezone || 'America/New_York';
            document.getElementById('day-report-time').value = data.day_report_time || '17:30';
            document.getElementById('night-report-time').value = data.night_report_time || '05:30';

        } catch (e) {
            console.error('Failed to load status:', e);
        }
    },

    async toggleAutoReport(enabled) {
        try {
            const res = await fetch('/api/reports/config/auto_report', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enabled})
            });
            const data = await res.json();

            if (data.ok) {
                TOAST?.success?.(data.message);
                this.loadStatus();
            } else {
                TOAST?.error?.(data.error || 'Failed');
                // Revert toggle
                document.getElementById('auto-report-toggle').checked = !enabled;
            }
        } catch (e) {
            TOAST?.error?.('Error: ' + e.message);
            document.getElementById('auto-report-toggle').checked = !enabled;
        }
    },

    async setStartupBehavior(autoStart) {
        try {
            const res = await fetch('/api/reports/config/startup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({auto_report_on_startup: autoStart})
            });
            const data = await res.json();

            if (data.ok) {
                TOAST?.success?.(data.message);
            } else {
                TOAST?.error?.(data.error || 'Failed');
            }
        } catch (e) {
            TOAST?.error?.('Error: ' + e.message);
        }
    },

    async saveTimes() {
        const timezone = document.getElementById('timezone-select').value;
        const dayTime = document.getElementById('day-report-time').value;
        const nightTime = document.getElementById('night-report-time').value;

        try {
            // Save timezone
            await fetch('/api/reports/config/timezone', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({timezone})
            });

            // Save times
            const res = await fetch('/api/reports/config/times', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    day_report_time: dayTime,
                    night_report_time: nightTime
                })
            });
            const data = await res.json();

            if (data.ok) {
                TOAST?.success?.('Report times saved');
                this.loadStatus();
            } else {
                TOAST?.error?.(data.error || 'Failed');
            }
        } catch (e) {
            TOAST?.error?.('Error: ' + e.message);
        }
    },

    async loadBCEmails() {
        try {
            const res = await fetch('/api/reports/battalion_chiefs');
            const data = await res.json();

            const container = document.getElementById('bc-email-list');
            if (data.battalion_chiefs) {
                container.innerHTML = Object.entries(data.battalion_chiefs).map(([shift, bc]) => `
                    <div class="bc-item">
                        <div class="bc-shift">${shift}</div>
                        <div class="bc-info">
                            <div class="bc-name">${bc.name}</div>
                            <input type="email" class="bc-email-input"
                                id="bc-email-${shift}"
                                value="${bc.email || ''}"
                                placeholder="Enter email...">
                        </div>
                        <button class="bc-test-btn" onclick="REPORTS_ADMIN.saveBCEmail('${shift}')">Save</button>
                    </div>
                `).join('');
            }
        } catch (e) {
            console.error('Failed to load BC emails:', e);
        }
    },

    async saveBCEmail(shift) {
        const email = document.getElementById(`bc-email-${shift}`)?.value?.trim();

        try {
            const res = await fetch(`/api/reports/battalion_chiefs/${shift}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email})
            });
            const data = await res.json();

            if (data.ok) {
                TOAST?.success?.(`Shift ${shift} email saved`);
            } else {
                TOAST?.error?.(data.error || 'Failed');
            }
        } catch (e) {
            TOAST?.error?.('Error: ' + e.message);
        }
    },

    async loadRecipients() {
        try {
            const res = await fetch('/api/reports/config/recipients');
            const data = await res.json();

            if (data.recipients?.length) {
                document.getElementById('additional-recipients').value = data.recipients.join('\n');
            }
        } catch (e) {
            console.error('Failed to load recipients:', e);
        }
    },

    async saveRecipients() {
        const text = document.getElementById('additional-recipients').value;
        const recipients = text.split(/[\n,]/).map(e => e.trim()).filter(e => e);

        try {
            const res = await fetch('/api/reports/config/recipients', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({recipients})
            });
            const data = await res.json();

            if (data.ok) {
                TOAST?.success?.(data.message || 'Recipients saved');
            } else {
                TOAST?.error?.(data.error || 'Failed');
            }
        } catch (e) {
            TOAST?.error?.('Error: ' + e.message);
        }
    },

    async loadEmailConfig() {
        try {
            const res = await fetch('/api/reports/config');
            const data = await res.json();

            // Update status display
            const statusEl = document.getElementById('email-config-status');
            statusEl.innerHTML = `
                <div class="config-status-item">
                    <span class="${data.sendgrid_configured ? 'check' : 'cross'}">
                        ${data.sendgrid_configured ? '' : ''}
                    </span>
                    SendGrid API Key: ${data.sendgrid_configured ? 'Configured' : 'Not configured'}
                </div>
                <div class="config-status-item">
                    <span class="${data.smtp_from ? 'check' : 'cross'}">
                        ${data.smtp_from ? '' : ''}
                    </span>
                    From Email: ${data.smtp_from || 'Not set'}
                </div>
            `;

            if (data.smtp_from) {
                document.getElementById('from-email').value = data.smtp_from;
            }
        } catch (e) {
            console.error('Failed to load email config:', e);
        }
    },

    async saveEmailConfig() {
        const apiKey = document.getElementById('sendgrid-api-key').value.trim();
        const fromEmail = document.getElementById('from-email').value.trim();

        if (!apiKey && !fromEmail) {
            TOAST?.error?.('Enter at least one value');
            return;
        }

        try {
            const res = await fetch('/api/reports/config/sendgrid', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    api_key: apiKey || undefined,
                    from_email: fromEmail || undefined
                })
            });
            const data = await res.json();

            if (data.ok) {
                TOAST?.success?.(data.message || 'Email config saved');
                this.loadEmailConfig();
                // Clear API key field after save
                document.getElementById('sendgrid-api-key').value = '';
            } else {
                TOAST?.error?.(data.error || 'Failed');
            }
        } catch (e) {
            TOAST?.error?.('Error: ' + e.message);
        }
    },

    async sendTestEmail() {
        const email = document.getElementById('test-email-address').value.trim();
        if (!email) {
            TOAST?.error?.('Enter an email address');
            return;
        }

        TOAST?.info?.('Sending test email...');

        try {
            const res = await fetch('/api/reports/test-email', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email})
            });
            const data = await res.json();

            if (data.ok) {
                TOAST?.success?.(data.message);
            } else {
                TOAST?.error?.(data.error || 'Failed to send');
            }
        } catch (e) {
            TOAST?.error?.('Error: ' + e.message);
        }
    },

    async sendReportNow() {
        if (!confirm('Send the daily report now to all configured recipients?')) return;

        TOAST?.info?.('Sending report...');

        try {
            const res = await fetch('/api/reports/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({include_battalion_chiefs: true})
            });
            const data = await res.json();

            if (data.ok) {
                TOAST?.success?.(`Report sent to ${data.recipients?.length || 0} recipient(s)`);
            } else {
                TOAST?.error?.(data.error || 'Failed to send');
            }
        } catch (e) {
            TOAST?.error?.('Error: ' + e.message);
        }
    },

    previewReport() {
        window.open('/api/reports/preview', '_blank');
    },

    togglePassword(id) {
        const input = document.getElementById(id);
        if (input) {
            input.type = input.type === 'password' ? 'text' : 'password';
        }
    },

    // ======== Schedules Tab (v3 API) ========

    _schedTemplates: [],
    _schedEditId: null,

    async loadSchedules() {
        const tbody = document.getElementById('sched-table-body');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="7" class="sched-loading">Loading schedules...</td></tr>';

        try {
            const res = await fetch('/api/reporting/schedules');
            const data = await res.json();
            const schedules = data.schedules || data || [];

            if (!Array.isArray(schedules) || schedules.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="sched-empty">No schedules configured yet.</td></tr>';
                return;
            }

            tbody.innerHTML = schedules.map(s => `
                <tr data-sched-id="${s.id}">
                    <td>${this._esc(s.name || '--')}</td>
                    <td>${this._esc(s.template || s.template_id || '--')}</td>
                    <td><span class="sched-freq-badge">${this._esc(s.frequency || '--')}</span></td>
                    <td>
                        <label class="sched-toggle-label">
                            <input type="checkbox" ${s.enabled ? 'checked' : ''}
                                onchange="REPORTS_ADMIN.toggleScheduleEnabled('${s.id}', this.checked)">
                            <span class="sched-toggle-slider"></span>
                        </label>
                    </td>
                    <td>${s.next_run ? this._fmtDate(s.next_run) : '--'}</td>
                    <td>${s.last_run ? this._fmtDate(s.last_run) : '--'}</td>
                    <td>
                        <div class="sched-actions">
                            <button onclick="REPORTS_ADMIN.editSchedule('${s.id}')">Edit</button>
                            <button class="sched-btn-run" onclick="REPORTS_ADMIN.runScheduleNow('${s.id}')">Run</button>
                            <button class="sched-btn-del" onclick="REPORTS_ADMIN.deleteSchedule('${s.id}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        } catch (e) {
            console.error('Failed to load schedules:', e);
            tbody.innerHTML = '<tr><td colspan="7" class="sched-empty">Error loading schedules.</td></tr>';
        }
    },

    async loadSchedTemplates() {
        try {
            const res = await fetch('/api/reporting/templates');
            const data = await res.json();
            const templates = data.templates || data || [];
            this._schedTemplates = templates;

            const sel = document.getElementById('sched-template');
            if (!sel) return;
            sel.innerHTML = '<option value="">-- Select Template --</option>' +
                templates.map(t => {
                    const id = t.id || t.template_id || t;
                    const name = t.name || t.label || id;
                    return `<option value="${this._esc(String(id))}">${this._esc(String(name))}</option>`;
                }).join('');
        } catch (e) {
            console.error('Failed to load templates:', e);
            const sel = document.getElementById('sched-template');
            if (sel) sel.innerHTML = '<option value="">Error loading templates</option>';
        }
    },

    toggleSchedForm() {
        const panel = document.getElementById('sched-form-panel');
        const title = document.getElementById('sched-form-title');
        if (!panel) return;
        const visible = panel.style.display !== 'none';
        panel.style.display = visible ? 'none' : 'block';
        if (!this._schedEditId) {
            title.textContent = visible ? '+ Create New Schedule' : '- Create New Schedule';
        }
    },

    onFrequencyChange() {
        const freq = document.getElementById('sched-frequency')?.value;
        document.querySelectorAll('.sched-cond').forEach(el => el.style.display = 'none');
        if (freq === 'weekly') {
            document.querySelectorAll('.sched-cond-weekly').forEach(el => el.style.display = 'flex');
        } else if (freq === 'monthly') {
            document.querySelectorAll('.sched-cond-monthly').forEach(el => el.style.display = 'flex');
        } else if (freq === 'once') {
            document.querySelectorAll('.sched-cond-once').forEach(el => el.style.display = 'flex');
        }
    },

    toggleChannel(ch) {
        const checked = document.getElementById(`sched-ch-${ch}`)?.checked;
        const detail = document.getElementById(`sched-ch-${ch}-detail`);
        if (detail) detail.style.display = checked ? 'flex' : 'none';
    },

    _collectFormData() {
        const name = document.getElementById('sched-name')?.value?.trim();
        const template = document.getElementById('sched-template')?.value;
        const shift = document.getElementById('sched-shift')?.value;
        const frequency = document.getElementById('sched-frequency')?.value;

        if (!name) { TOAST?.error?.('Schedule name is required'); return null; }
        if (!template) { TOAST?.error?.('Please select a template'); return null; }

        const payload = { name, template_id: template, shift, frequency };

        // Conditional fields
        if (frequency === 'weekly') {
            const days = [];
            document.querySelectorAll('.sched-cond-weekly input[type=checkbox]:checked').forEach(cb => {
                days.push(parseInt(cb.value, 10));
            });
            if (days.length === 0) { TOAST?.error?.('Select at least one day for weekly schedule'); return null; }
            payload.days_of_week = days;
        } else if (frequency === 'monthly') {
            payload.day_of_month = parseInt(document.getElementById('sched-day-of-month')?.value, 10) || 1;
        } else if (frequency === 'once') {
            const runAt = document.getElementById('sched-run-at')?.value;
            if (!runAt) { TOAST?.error?.('Select a date/time for one-time schedule'); return null; }
            payload.run_at = runAt;
        }

        // Delivery channels
        const channels = [];
        if (document.getElementById('sched-ch-email')?.checked) {
            const addr = document.getElementById('sched-email-addr')?.value?.trim();
            if (!addr) { TOAST?.error?.('Enter an email address for email delivery'); return null; }
            channels.push({ type: 'email', address: addr });
        }
        if (document.getElementById('sched-ch-sms')?.checked) {
            const phone = document.getElementById('sched-sms-phone')?.value?.trim();
            if (!phone) { TOAST?.error?.('Enter a phone number for SMS delivery'); return null; }
            channels.push({ type: 'sms', phone: phone });
        }
        if (document.getElementById('sched-ch-webhook')?.checked) {
            const url = document.getElementById('sched-webhook-url')?.value?.trim();
            if (!url) { TOAST?.error?.('Enter a URL for webhook delivery'); return null; }
            channels.push({ type: 'webhook', url: url });
        }
        if (document.getElementById('sched-ch-signal')?.checked) {
            const phone = document.getElementById('sched-signal-phone')?.value?.trim();
            if (!phone) { TOAST?.error?.('Enter a phone number for Signal delivery'); return null; }
            channels.push({ type: 'signal', phone: phone });
        }
        if (document.getElementById('sched-ch-webex')?.checked) {
            const room = document.getElementById('sched-webex-room')?.value?.trim();
            if (!room) { TOAST?.error?.('Enter a room ID for Webex delivery'); return null; }
            channels.push({ type: 'webex', room_id: room });
        }
        payload.channels = channels;

        // Output format
        const fmt = document.getElementById('sched-format')?.value;
        if (fmt) payload.format = fmt;

        return payload;
    },

    async saveSchedule() {
        const payload = this._collectFormData();
        if (!payload) return;

        const editId = this._schedEditId;
        const url = editId ? `/api/reporting/schedule/${editId}` : '/api/reporting/schedule';
        const verb = editId ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, {
                method: verb,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (res.ok && (data.ok !== false)) {
                TOAST?.success?.(editId ? 'Schedule updated' : 'Schedule created');
                this._resetSchedForm();
                this.loadSchedules();
            } else {
                TOAST?.error?.(data.error || data.message || 'Failed to save schedule');
            }
        } catch (e) {
            TOAST?.error?.('Error: ' + e.message);
        }
    },

    async editSchedule(id) {
        // Fetch all schedules and find the one to edit
        try {
            const res = await fetch('/api/reporting/schedules');
            const data = await res.json();
            const schedules = data.schedules || data || [];
            const sched = schedules.find(s => String(s.id) === String(id));

            if (!sched) {
                TOAST?.error?.('Schedule not found');
                return;
            }

            // Open form
            const panel = document.getElementById('sched-form-panel');
            panel.style.display = 'block';
            document.getElementById('sched-form-title').textContent = '- Edit Schedule';

            this._schedEditId = id;
            document.getElementById('sched-edit-id').value = id;
            document.getElementById('sched-name').value = sched.name || '';
            document.getElementById('sched-template').value = sched.template_id || sched.template || '';
            document.getElementById('sched-shift').value = sched.shift || 'all';
            document.getElementById('sched-frequency').value = sched.frequency || 'daily';
            this.onFrequencyChange();

            // Weekly days
            if (sched.frequency === 'weekly' && sched.days_of_week) {
                document.querySelectorAll('.sched-cond-weekly input[type=checkbox]').forEach(cb => {
                    cb.checked = sched.days_of_week.includes(parseInt(cb.value, 10));
                });
            }

            // Monthly
            if (sched.frequency === 'monthly' && sched.day_of_month) {
                document.getElementById('sched-day-of-month').value = sched.day_of_month;
            }

            // Once
            if (sched.frequency === 'once' && sched.run_at) {
                document.getElementById('sched-run-at').value = sched.run_at;
            }

            // Channels
            this._resetChannels();
            if (sched.channels && Array.isArray(sched.channels)) {
                sched.channels.forEach(ch => {
                    if (ch.type === 'email') {
                        document.getElementById('sched-ch-email').checked = true;
                        document.getElementById('sched-ch-email-detail').style.display = 'flex';
                        document.getElementById('sched-email-addr').value = ch.address || '';
                    } else if (ch.type === 'sms') {
                        document.getElementById('sched-ch-sms').checked = true;
                        document.getElementById('sched-ch-sms-detail').style.display = 'flex';
                        document.getElementById('sched-sms-phone').value = ch.phone || '';
                    } else if (ch.type === 'webhook') {
                        document.getElementById('sched-ch-webhook').checked = true;
                        document.getElementById('sched-ch-webhook-detail').style.display = 'flex';
                        document.getElementById('sched-webhook-url').value = ch.url || '';
                    } else if (ch.type === 'signal') {
                        const el = document.getElementById('sched-ch-signal');
                        if (el) { el.checked = true; document.getElementById('sched-ch-signal-detail').style.display = 'flex'; }
                        const phoneEl = document.getElementById('sched-signal-phone');
                        if (phoneEl) phoneEl.value = ch.phone || '';
                    } else if (ch.type === 'webex') {
                        const el = document.getElementById('sched-ch-webex');
                        if (el) { el.checked = true; document.getElementById('sched-ch-webex-detail').style.display = 'flex'; }
                        const roomEl = document.getElementById('sched-webex-room');
                        if (roomEl) roomEl.value = ch.room_id || '';
                    }
                });
            }

            // Update button labels
            document.getElementById('sched-submit-btn').textContent = 'Update Schedule';
            document.getElementById('sched-cancel-btn').style.display = 'inline-flex';

            // Scroll form into view
            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } catch (e) {
            TOAST?.error?.('Error loading schedule: ' + e.message);
        }
    },

    cancelEditSchedule() {
        this._resetSchedForm();
    },

    _resetSchedForm() {
        this._schedEditId = null;
        document.getElementById('sched-edit-id').value = '';
        document.getElementById('sched-name').value = '';
        document.getElementById('sched-template').value = '';
        document.getElementById('sched-shift').value = 'all';
        document.getElementById('sched-frequency').value = 'shift_change';
        document.getElementById('sched-day-of-month').value = '1';
        document.getElementById('sched-run-at').value = '';
        document.querySelectorAll('.sched-cond').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.sched-cond-weekly input[type=checkbox]').forEach(cb => cb.checked = false);
        this._resetChannels();
        document.getElementById('sched-submit-btn').textContent = 'Create Schedule';
        document.getElementById('sched-cancel-btn').style.display = 'none';
        document.getElementById('sched-form-title').textContent = '+ Create New Schedule';
        document.getElementById('sched-form-panel').style.display = 'none';
    },

    _resetChannels() {
        ['email', 'sms', 'webhook', 'signal', 'webex'].forEach(ch => {
            const cb = document.getElementById(`sched-ch-${ch}`);
            if (cb) cb.checked = false;
            const detail = document.getElementById(`sched-ch-${ch}-detail`);
            if (detail) detail.style.display = 'none';
        });
        document.getElementById('sched-email-addr').value = '';
        document.getElementById('sched-sms-phone').value = '';
        document.getElementById('sched-webhook-url').value = '';
        const signalEl = document.getElementById('sched-signal-phone');
        if (signalEl) signalEl.value = '';
        const webexEl = document.getElementById('sched-webex-room');
        if (webexEl) webexEl.value = '';
    },

    async toggleScheduleEnabled(id, enabled) {
        try {
            const res = await fetch(`/api/reporting/schedule/${id}/toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled })
            });
            const data = await res.json();
            if (res.ok && (data.ok !== false)) {
                TOAST?.success?.(enabled ? 'Schedule enabled' : 'Schedule disabled');
            } else {
                TOAST?.error?.(data.error || 'Failed to toggle schedule');
                this.loadSchedules(); // revert UI
            }
        } catch (e) {
            TOAST?.error?.('Error: ' + e.message);
            this.loadSchedules();
        }
    },

    async runScheduleNow(id) {
        if (!confirm('Run this schedule immediately?')) return;
        try {
            const res = await fetch(`/api/reporting/schedule/${id}/run_now`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            if (res.ok && (data.ok !== false)) {
                TOAST?.success?.(data.message || 'Schedule triggered');
                this.loadSchedules();
            } else {
                TOAST?.error?.(data.error || 'Failed to run schedule');
            }
        } catch (e) {
            TOAST?.error?.('Error: ' + e.message);
        }
    },

    async deleteSchedule(id) {
        if (!confirm('Delete this schedule permanently?')) return;
        try {
            const res = await fetch(`/api/reporting/schedule/${id}`, {
                method: 'DELETE'
            });
            const data = await res.json();
            if (res.ok && (data.ok !== false)) {
                TOAST?.success?.('Schedule deleted');
                this.loadSchedules();
            } else {
                TOAST?.error?.(data.error || 'Failed to delete schedule');
            }
        } catch (e) {
            TOAST?.error?.('Error: ' + e.message);
        }
    },

    // ======== Analytics Tab ========

    _analyticsCharts: {},
    _analyticsData: null,

    _getAnalyticsDateRange() {
        const preset = document.getElementById('analytics-preset')?.value || '30d';
        const now = new Date();
        let start, end = new Date(now);

        if (preset === 'custom') {
            const sVal = document.getElementById('analytics-start')?.value;
            const eVal = document.getElementById('analytics-end')?.value;
            if (sVal && eVal) {
                return { date_start: sVal + ' 00:00:00', date_end: eVal + ' 23:59:59' };
            }
        }

        switch (preset) {
            case '7d': start = new Date(now - 7 * 86400000); break;
            case '90d': start = new Date(now - 90 * 86400000); break;
            case 'mtd': start = new Date(now.getFullYear(), now.getMonth(), 1); break;
            case 'ytd': start = new Date(now.getFullYear(), 0, 1); break;
            default: start = new Date(now - 30 * 86400000); break;
        }

        const fmt = d => d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        return { date_start: fmt(start) + ' 00:00:00', date_end: fmt(end) + ' 23:59:59' };
    },

    onAnalyticsPresetChange() {
        const preset = document.getElementById('analytics-preset')?.value;
        const showCustom = preset === 'custom';
        document.getElementById('analytics-start').style.display = showCustom ? 'block' : 'none';
        document.getElementById('analytics-end').style.display = showCustom ? 'block' : 'none';
    },

    async loadAnalytics() {
        const range = this._getAnalyticsDateRange();
        try {
            // Use the executive_summary extractor via the run API with preview
            const res = await fetch('/api/reporting/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    template_key: 'executive_summary',
                    filters: range,
                    formats: ['html']
                })
            });
            const result = await res.json();
            if (!result.ok) {
                console.error('Analytics load failed:', result.error);
                return;
            }

            const data = result.data || {};
            this._analyticsData = data;
            const stats = data.stats || {};
            const chartData = data.chart_data || {};

            // Update KPI cards
            document.getElementById('kpi-total-incidents').textContent = stats.total_incidents ?? '--';
            document.getElementById('kpi-avg-response').textContent =
                stats.avg_response_time != null ? stats.avg_response_time.toFixed(1) + ' min' : '--';
            document.getElementById('kpi-p90-response').textContent =
                stats.p90_response_time != null ? stats.p90_response_time.toFixed(1) + ' min' : '--';
            document.getElementById('kpi-compliance').textContent =
                stats.compliance_pct != null ? stats.compliance_pct.toFixed(0) + '%' : '--';
            document.getElementById('kpi-active-units').textContent = stats.active_units ?? '--';

            // Render Chart.js charts
            this._renderAnalyticsCharts(chartData);
        } catch (e) {
            console.error('Analytics load error:', e);
        }
    },

    _renderAnalyticsCharts(chartData) {
        if (typeof Chart === 'undefined') {
            console.warn('Chart.js not loaded');
            return;
        }

        // Destroy previous charts
        Object.values(this._analyticsCharts).forEach(c => c?.destroy?.());
        this._analyticsCharts = {};

        const fordBlue = '#003478';
        const fireRed = '#dc2626';
        const green = '#16a34a';

        // Trend line chart
        const dt = chartData.daily_trend || {};
        if (dt.labels?.length) {
            const ctx = document.getElementById('analytics-trend-chart')?.getContext('2d');
            if (ctx) {
                this._analyticsCharts.trend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dt.labels,
                        datasets: [{
                            label: 'Incidents',
                            data: dt.values,
                            borderColor: fordBlue,
                            backgroundColor: fordBlue + '20',
                            fill: true,
                            tension: 0.3,
                            pointRadius: dt.labels.length > 30 ? 0 : 3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { maxTicksLimit: 10, font: { size: 10 } } },
                            y: { beginAtZero: true, ticks: { font: { size: 10 } } }
                        }
                    }
                });
            }
        }

        // Type donut chart
        const tb = chartData.type_breakdown || {};
        if (tb.labels?.length) {
            const ctx = document.getElementById('analytics-type-chart')?.getContext('2d');
            if (ctx) {
                const palette = [fordBlue, fireRed, green, '#ca8a04', '#7c3aed', '#0891b2', '#c026d3', '#ea580c'];
                this._analyticsCharts.type = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: tb.labels,
                        datasets: [{
                            data: tb.values,
                            backgroundColor: tb.labels.map((_, i) => palette[i % palette.length]),
                            borderWidth: 2,
                            borderColor: '#fff',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { font: { size: 10 }, boxWidth: 12 } }
                        },
                        cutout: '55%',
                    }
                });
            }
        }

        // Hourly bar chart (use incident_analytics data if available)
        const hp = chartData.hourly_pattern || {};
        if (hp.labels?.length) {
            const ctx = document.getElementById('analytics-hourly-chart')?.getContext('2d');
            if (ctx) {
                this._analyticsCharts.hourly = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: hp.labels,
                        datasets: [{
                            label: 'Incidents',
                            data: hp.values,
                            backgroundColor: fordBlue + 'cc',
                            borderRadius: 3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { font: { size: 9 } } },
                            y: { beginAtZero: true, ticks: { font: { size: 10 } } }
                        }
                    }
                });
            }
        }
    },

    async generateAnalyticsReport() {
        const template = document.getElementById('analytics-template')?.value || 'executive_summary';
        const format = document.getElementById('analytics-format')?.value || 'html';
        const range = this._getAnalyticsDateRange();

        TOAST?.info?.('Generating report...');

        try {
            const res = await fetch('/api/reporting/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    template_key: template,
                    filters: range,
                    formats: [format, 'html']
                })
            });
            const result = await res.json();

            if (result.ok) {
                TOAST?.success?.('Report generated successfully');
                // Download if available
                const token = result.download_tokens?.[format] || result.download_tokens?.html;
                if (token) {
                    window.open(`/api/reporting/download/${token}`, '_blank');
                }
            } else {
                TOAST?.error?.(result.error || 'Report generation failed');
            }
        } catch (e) {
            TOAST?.error?.('Error: ' + e.message);
        }
    },

    previewAnalyticsReport() {
        const template = document.getElementById('analytics-template')?.value || 'executive_summary';
        const range = this._getAnalyticsDateRange();
        const params = new URLSearchParams({
            template_key: template,
            date_start: range.date_start,
            date_end: range.date_end
        });
        window.open('/api/reports/preview?' + params.toString(), '_blank');
    },

    scheduleAnalyticsReport() {
        // Switch to schedules tab and pre-fill the form
        const template = document.getElementById('analytics-template')?.value || 'executive_summary';
        const schedTab = document.querySelector('.admin-tab[data-tab="schedules"]');
        if (schedTab) schedTab.click();

        // Wait for tab switch, then fill
        setTimeout(() => {
            this.toggleSchedForm();
            this.loadSchedTemplates().then(() => {
                const sel = document.getElementById('sched-template');
                if (sel) sel.value = template;
            });
            document.getElementById('sched-name').value =
                document.getElementById('analytics-template')?.selectedOptions[0]?.text || 'Analytics Report';
        }, 200);
    },

    _esc(str) {
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    },

    _fmtDate(dateStr) {
        try {
            const d = new Date(dateStr);
            return d.toLocaleString('en-US', {
                month: 'short', day: 'numeric',
                hour: 'numeric', minute: '2-digit',
                hour12: true
            });
        } catch (_) {
            return dateStr;
        }
    }
};

// Initialize when modal opens
setTimeout(() => REPORTS_ADMIN.init(), 100);
</script>
