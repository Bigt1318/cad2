{% set is_admin = is_admin|default(false) %}
<!-- Reporting Modal â€” 4-Tab Production UI for FORD-CAD (v4) -->
<div class="cad-modal-overlay" onclick="CAD_MODAL.close()"></div>
<div class="cad-modal reporting-modal" role="dialog" aria-modal="true" aria-label="Reporting">
    <div class="cad-modal-header">
        <div class="cad-modal-title">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                <polyline points="14,2 14,8 20,8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
            Reporting
        </div>
        <button class="cad-modal-close" onclick="CAD_MODAL.close()">&times;</button>
    </div>
    <div class="cad-modal-body">
        <div class="rpt-container">
            <!-- Tab Navigation -->
            <div class="rpt-tabs" role="tablist">
                <button class="rpt-tab active" data-tab="run" role="tab" aria-selected="true" aria-controls="rpt-panel-run">Run</button>
                <button class="rpt-tab" data-tab="analytics" role="tab" aria-selected="false" aria-controls="rpt-panel-analytics">Analytics</button>
                <button class="rpt-tab" data-tab="builder" role="tab" aria-selected="false" aria-controls="rpt-panel-builder">Builder</button>
                <button class="rpt-tab" data-tab="history" role="tab" aria-selected="false" aria-controls="rpt-panel-history">History</button>
            </div>

            <!-- ============================================================ -->
            <!-- TAB 1: RUN                                                   -->
            <!-- ============================================================ -->
            <div class="rpt-panel active" id="rpt-panel-run" role="tabpanel">
                <!-- Template Picker -->
                <div class="rpt-section">
                    <div class="rpt-section-title">Template</div>
                    <select id="rpt-template-select" class="rpt-select" onchange="REPORTING.onTemplateChange()" aria-label="Select report template">
                        <option value="">-- Loading templates --</option>
                    </select>
                    <div id="rpt-template-desc" class="rpt-hint"></div>
                </div>

                <!-- Filters Panel -->
                <div class="rpt-section">
                    <div class="rpt-section-title">Filters</div>
                    <div class="rpt-filters-grid">
                        <!-- Date range preset -->
                        <div class="rpt-field">
                            <label for="rpt-date-preset">Date Range</label>
                            <select id="rpt-date-preset" class="rpt-select" onchange="REPORTING.onDatePresetChange()">
                                <option value="today">Today</option>
                                <option value="yesterday_today" selected>Yesterday to Today</option>
                                <option value="last_7">Last 7 Days</option>
                                <option value="last_30">Last 30 Days</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <!-- Start Date (shown always but auto-set by preset) -->
                        <div class="rpt-field" id="rpt-date-start-wrap">
                            <label for="rpt-date-start">Start Date</label>
                            <input type="date" id="rpt-date-start" class="rpt-input">
                        </div>
                        <!-- End Date -->
                        <div class="rpt-field" id="rpt-date-end-wrap">
                            <label for="rpt-date-end">End Date</label>
                            <input type="date" id="rpt-date-end" class="rpt-input">
                        </div>
                        <!-- Time range -->
                        <div class="rpt-field">
                            <label for="rpt-time-from">From Time (24hr)</label>
                            <input type="text" id="rpt-time-from" class="rpt-input" placeholder="e.g. 0600" maxlength="4">
                        </div>
                        <div class="rpt-field">
                            <label for="rpt-time-to">To Time (24hr)</label>
                            <input type="text" id="rpt-time-to" class="rpt-input" placeholder="e.g. 1800" maxlength="4">
                        </div>
                        <!-- Shift -->
                        <div class="rpt-field">
                            <label for="rpt-shift-select">Shift</label>
                            <select id="rpt-shift-select" class="rpt-select">
                                <option value="">All Shifts</option>
                                <option value="A">A Shift</option>
                                <option value="B">B Shift</option>
                                <option value="C">C Shift</option>
                                <option value="D">D Shift</option>
                            </select>
                        </div>
                        <!-- Event Type -->
                        <div class="rpt-field">
                            <label for="rpt-event-type">Event Type</label>
                            <input type="text" id="rpt-event-type" class="rpt-input" placeholder="e.g. FIRE, EMS">
                        </div>
                        <!-- Calltaker -->
                        <div class="rpt-field">
                            <label for="rpt-calltaker">Calltaker</label>
                            <input type="text" id="rpt-calltaker" class="rpt-input" placeholder="Name or ID">
                        </div>
                        <!-- Status -->
                        <div class="rpt-field">
                            <label for="rpt-status-filter">Status</label>
                            <select id="rpt-status-filter" class="rpt-select">
                                <option value="">All</option>
                                <option value="open">Open</option>
                                <option value="closed">Closed</option>
                                <option value="held">Held</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Apparatus Checkboxes -->
                <div class="rpt-section">
                    <div class="rpt-section-title">
                        Apparatus
                        <span class="rpt-section-actions">
                            <button class="rpt-link-btn" onclick="REPORTING.selectAllApparatus()">Select All</button>
                            <span class="rpt-separator">|</span>
                            <button class="rpt-link-btn" onclick="REPORTING.clearAllApparatus()">Clear All</button>
                        </span>
                    </div>
                    <div class="rpt-apparatus-checks" id="rpt-apparatus-checks">
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-apparatus" value="Engine1" checked> E1 - Engine 1</label>
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-apparatus" value="Engine2" checked> E2 - Engine 2</label>
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-apparatus" value="Medic1" checked> M1 - Medic 1</label>
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-apparatus" value="Medic2" checked> M2 - Medic 2</label>
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-apparatus" value="Tower1" checked> T1 - Tower 1</label>
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-apparatus" value="SQ1" checked> SQ1 - Squirt 1</label>
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-apparatus" value="UTV1" checked> UTV1 - UTV 1</label>
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-apparatus" value="UTV2" checked> UTV2 - UTV 2</label>
                    </div>
                </div>

                <!-- Mode Toggle -->
                <div class="rpt-section">
                    <div class="rpt-section-title">Mode</div>
                    <div class="rpt-toggle-group" id="rpt-mode-toggle">
                        <button class="rpt-toggle-btn active" data-mode="condensed" onclick="REPORTING.setMode(this)">Condensed</button>
                        <button class="rpt-toggle-btn" data-mode="detailed" onclick="REPORTING.setMode(this)">Detailed</button>
                    </div>
                </div>

                <!-- Output Formats -->
                <div class="rpt-section">
                    <div class="rpt-section-title">Output Format</div>
                    <div class="rpt-format-checks">
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-format" value="pdf" checked> PDF</label>
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-format" value="csv"> CSV</label>
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-format" value="xlsx"> XLSX</label>
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-format" value="html"> HTML</label>
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-format" value="txt"> TXT</label>
                    </div>
                </div>

                <!-- Actions -->
                <div class="rpt-actions">
                    <button class="rpt-btn-primary" onclick="REPORTING.runReport()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5,3 19,12 5,21 5,3"></polygon></svg>
                        Run Report
                    </button>
                    <button class="rpt-btn-secondary" onclick="REPORTING.previewReport()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        Preview
                    </button>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- TAB 2: ANALYTICS                                             -->
            <!-- ============================================================ -->
            <div class="rpt-panel" id="rpt-panel-analytics" role="tabpanel">
                <!-- Date Range -->
                <div class="rpt-section">
                    <div class="rpt-section-title">Date Range</div>
                    <div class="analytics-date-row">
                        <select id="analytics-preset" class="rpt-select" style="max-width:170px;" onchange="REPORTING.onAnalyticsPresetChange()">
                            <option value="7d">Last 7 Days</option>
                            <option value="30d" selected>Last 30 Days</option>
                            <option value="90d">Last 90 Days</option>
                            <option value="mtd">Month to Date</option>
                            <option value="ytd">Year to Date</option>
                            <option value="custom">Custom</option>
                        </select>
                        <input type="date" id="analytics-date-from" class="rpt-input" style="max-width:150px;">
                        <span style="color:var(--text-secondary);">to</span>
                        <input type="date" id="analytics-date-to" class="rpt-input" style="max-width:150px;">
                        <button class="rpt-btn-primary rpt-btn-sm" onclick="REPORTING.loadAnalytics()">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23,4 23,10 17,10"></polyline><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"></path></svg>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="rpt-section">
                    <div class="analytics-kpi-row" id="analytics-kpi-row">
                        <div class="analytics-kpi-card">
                            <div class="analytics-kpi-value" id="kpi-total-incidents">--</div>
                            <div class="analytics-kpi-label">Total Incidents</div>
                            <div class="analytics-kpi-trend" id="kpi-trend-incidents"></div>
                        </div>
                        <div class="analytics-kpi-card">
                            <div class="analytics-kpi-value" id="kpi-avg-response">--</div>
                            <div class="analytics-kpi-label">Avg Response Time</div>
                            <div class="analytics-kpi-trend" id="kpi-trend-response"></div>
                        </div>
                        <div class="analytics-kpi-card">
                            <div class="analytics-kpi-value" id="kpi-p90-response">--</div>
                            <div class="analytics-kpi-label">90th Percentile</div>
                            <div class="analytics-kpi-trend" id="kpi-trend-p90"></div>
                        </div>
                        <div class="analytics-kpi-card">
                            <div class="analytics-kpi-value" id="kpi-compliance">--</div>
                            <div class="analytics-kpi-label">Compliance %</div>
                            <div class="analytics-kpi-trend" id="kpi-trend-compliance"></div>
                        </div>
                        <div class="analytics-kpi-card">
                            <div class="analytics-kpi-value" id="kpi-active-units">--</div>
                            <div class="analytics-kpi-label">Active Units</div>
                            <div class="analytics-kpi-trend" id="kpi-trend-units"></div>
                        </div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="rpt-section">
                    <div class="analytics-charts-grid">
                        <div class="analytics-chart-panel span-2">
                            <div class="analytics-chart-title">Incident Trend</div>
                            <canvas id="chart-incident-trend" height="200"></canvas>
                        </div>
                        <div class="analytics-chart-panel">
                            <div class="analytics-chart-title">Type Breakdown</div>
                            <canvas id="chart-type-breakdown" height="200"></canvas>
                        </div>
                        <div class="analytics-chart-panel">
                            <div class="analytics-chart-title">Hourly Pattern</div>
                            <canvas id="chart-hourly-pattern" height="200"></canvas>
                        </div>
                        <div class="analytics-chart-panel">
                            <div class="analytics-chart-title">Unit Utilization</div>
                            <canvas id="chart-unit-utilization" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Generate Report Section -->
                <div class="rpt-section">
                    <div class="rpt-section-title">Generate Analytics Report</div>
                    <div class="analytics-generate-row">
                        <select id="analytics-template-select" class="rpt-select" style="flex:1;">
                            <option value="executive_summary">Executive Summary Dashboard</option>
                            <option value="response_performance">Response Performance Analysis</option>
                            <option value="incident_analytics">Incident Analytics Report</option>
                            <option value="unit_performance">Unit Performance Dashboard</option>
                            <option value="department_overview">Department Overview Report</option>
                        </select>
                        <select id="analytics-format-select" class="rpt-select" style="max-width:100px;">
                            <option value="html">HTML</option>
                            <option value="pdf">PDF</option>
                            <option value="csv">CSV</option>
                            <option value="xlsx">XLSX</option>
                        </select>
                        <button class="rpt-btn-primary" onclick="REPORTING.generateAnalyticsReport()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5,3 19,12 5,21 5,3"></polygon></svg>
                            Generate
                        </button>
                        <button class="rpt-btn-secondary" onclick="REPORTING.previewAnalyticsReport()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            Preview
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- TAB 3: BUILDER                                               -->
            <!-- ============================================================ -->
            <div class="rpt-panel" id="rpt-panel-builder" role="tabpanel">
                <!-- Base Dataset -->
                <div class="rpt-section">
                    <div class="rpt-section-title">Base Dataset</div>
                    <div class="rpt-dataset-cards">
                        <button class="rpt-dataset-card active" data-dataset="dailylog" onclick="REPORTING.selectDataset(this)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline></svg>
                            Daily Log
                        </button>
                        <button class="rpt-dataset-card" data-dataset="incidents" onclick="REPORTING.selectDataset(this)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                            Incidents
                        </button>
                        <button class="rpt-dataset-card" data-dataset="units" onclick="REPORTING.selectDataset(this)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16,8 20,8 23,11 23,16 16,16 16,8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                            Units
                        </button>
                        <button class="rpt-dataset-card" data-dataset="calltaker" onclick="REPORTING.selectDataset(this)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                            Calltaker
                        </button>
                    </div>
                </div>

                <!-- Field Selection -->
                <div class="rpt-section">
                    <div class="rpt-section-title">Fields</div>
                    <div class="rpt-field-grid" id="rpt-field-grid">
                        <!-- Populated dynamically based on dataset -->
                    </div>
                </div>

                <!-- Group By -->
                <div class="rpt-section">
                    <div class="rpt-section-title">Group By (0-2)</div>
                    <div class="rpt-group-by-row">
                        <select id="rpt-group-by-1" class="rpt-select">
                            <option value="">-- None --</option>
                        </select>
                        <select id="rpt-group-by-2" class="rpt-select">
                            <option value="">-- None --</option>
                        </select>
                    </div>
                </div>

                <!-- Sort By -->
                <div class="rpt-section">
                    <div class="rpt-section-title">Sort By</div>
                    <div class="rpt-sort-row">
                        <select id="rpt-sort-field" class="rpt-select" style="flex:1;">
                            <option value="">-- None --</option>
                        </select>
                        <div class="rpt-toggle-group" id="rpt-sort-toggle">
                            <button class="rpt-toggle-btn active" data-sort="asc" onclick="REPORTING.setSortDir(this)">ASC</button>
                            <button class="rpt-toggle-btn" data-sort="desc" onclick="REPORTING.setSortDir(this)">DESC</button>
                        </div>
                    </div>
                </div>

                <!-- Aggregations -->
                <div class="rpt-section">
                    <div class="rpt-section-title">Aggregations</div>
                    <div class="rpt-agg-checks">
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-agg" value="count" checked> Count</label>
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-agg" value="avg"> Average</label>
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-agg" value="min"> Min</label>
                        <label class="rpt-check-label"><input type="checkbox" name="rpt-agg" value="max"> Max</label>
                    </div>
                </div>

                <!-- Save Template -->
                <div class="rpt-section rpt-save-section">
                    <div class="rpt-section-title">Save as Template</div>
                    <div class="rpt-save-row">
                        <input type="text" id="rpt-new-template-name" class="rpt-input" placeholder="My Custom Report" style="flex:1;">
                        <button class="rpt-btn-primary" onclick="REPORTING.saveCustomTemplate()">Save as Template</button>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- TAB 3: HISTORY                                               -->
            <!-- ============================================================ -->
            <div class="rpt-panel" id="rpt-panel-history" role="tabpanel">
                <!-- Filters -->
                <div class="rpt-section">
                    <div class="rpt-history-filters">
                        <input type="text" id="rpt-hist-search" class="rpt-input" placeholder="Search reports..." style="flex:2;" oninput="REPORTING.filterHistory()">
                        <select id="rpt-hist-template-filter" class="rpt-select" style="flex:1;" onchange="REPORTING.loadHistory()">
                            <option value="">All Templates</option>
                        </select>
                        <select id="rpt-hist-status-filter" class="rpt-select" style="flex:1;" onchange="REPORTING.loadHistory()">
                            <option value="">All Statuses</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                            <option value="partial">Partial</option>
                            <option value="running">Running</option>
                        </select>
                        <button class="rpt-btn-secondary" onclick="REPORTING.loadHistory()" aria-label="Refresh history" style="padding:8px 12px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23,4 23,10 17,10"></polyline><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- History table -->
                <div class="rpt-section">
                    <div class="rpt-table-wrap">
                        <table class="rpt-table" id="rpt-history-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Template</th>
                                    <th>Date Range</th>
                                    <th>Formats</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rpt-history-tbody">
                                <tr><td colspan="7" class="rpt-empty">No history loaded yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- REPORT VIEWER OVERLAY                                        -->
        <!-- ============================================================ -->
        <div class="rpt-viewer-overlay" id="rpt-viewer-overlay" style="display:none;">
            <div class="rpt-viewer-panel">
                <div class="rpt-viewer-header">
                    <span class="rpt-viewer-title" id="rpt-viewer-title">Report Viewer</span>
                    <button class="rpt-viewer-close" onclick="REPORTING.closeViewer()" aria-label="Close viewer">&times;</button>
                </div>
                <div class="rpt-viewer-content" id="rpt-viewer-content">
                    <!-- Report HTML rendered here -->
                </div>
                <div class="rpt-viewer-footer">
                    <div class="rpt-viewer-actions-left">
                        <button class="rpt-btn-primary rpt-btn-sm" onclick="REPORTING.viewerDownload('pdf')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path><polyline points="7,10 12,15 17,10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            PDF
                        </button>
                        <button class="rpt-btn-primary rpt-btn-sm" onclick="REPORTING.viewerDownload('csv')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path><polyline points="7,10 12,15 17,10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            CSV
                        </button>
                        <button class="rpt-btn-primary rpt-btn-sm" onclick="REPORTING.viewerDownload('xlsx')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path><polyline points="7,10 12,15 17,10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            XLSX
                        </button>
                    </div>
                    <div class="rpt-viewer-actions-right">
                        <div class="rpt-viewer-send-group">
                            <input type="email" id="rpt-viewer-email" class="rpt-input rpt-viewer-input" placeholder="Email address">
                            <button class="rpt-btn-secondary rpt-btn-sm" onclick="REPORTING.viewerSendEmail()">Send Email</button>
                        </div>
                        <div class="rpt-viewer-send-group">
                            <input type="tel" id="rpt-viewer-sms" class="rpt-input rpt-viewer-input" placeholder="Phone number">
                            <button class="rpt-btn-secondary rpt-btn-sm" onclick="REPORTING.viewerSendSMS()">Send SMS</button>
                        </div>
                        <button class="rpt-btn-secondary rpt-btn-sm" onclick="REPORTING.closeViewer()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="cad-modal-footer">
        <button class="btn-secondary" onclick="CAD_MODAL.close()">Close</button>
    </div>
</div>

<!-- ===================================================================== -->
<!-- SCOPED STYLES                                                         -->
<!-- ===================================================================== -->
<style>
/* ---- Modal size ---- */
.reporting-modal {
    min-width: 750px;
    max-width: 1000px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}
.reporting-modal .cad-modal-body {
    overflow-y: auto;
    flex: 1;
    min-height: 0;
    position: relative;
}

/* ---- Container ---- */
.reporting-modal .rpt-container {
    padding: var(--space-2);
}

/* ---- Tabs ---- */
.reporting-modal .rpt-tabs {
    display: flex;
    gap: 4px;
    border-bottom: 2px solid var(--border-default);
    margin-bottom: var(--space-3);
}
.reporting-modal .rpt-tab {
    padding: 10px 20px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.15s;
}
.reporting-modal .rpt-tab:hover {
    color: var(--ford-blue);
    background: var(--bg-active);
}
.reporting-modal .rpt-tab:focus-visible {
    outline: 2px solid var(--ford-blue);
    outline-offset: -2px;
}
.reporting-modal .rpt-tab.active {
    color: var(--ford-blue);
    border-bottom-color: var(--ford-blue);
}

/* ---- Panels ---- */
.reporting-modal .rpt-panel {
    display: none;
}
.reporting-modal .rpt-panel.active {
    display: block;
}

/* ---- Sections ---- */
.reporting-modal .rpt-section {
    margin-bottom: var(--space-4);
}
.reporting-modal .rpt-section-title {
    font-size: var(--text-sm);
    font-weight: 700;
    text-transform: uppercase;
    color: var(--text-secondary);
    margin-bottom: var(--space-2);
    padding-bottom: var(--space-1);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.reporting-modal .rpt-section-actions {
    display: inline-flex;
    align-items: center;
    gap: 6px;
}
.reporting-modal .rpt-link-btn {
    background: none;
    border: none;
    color: var(--ford-blue);
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    padding: 0;
    text-decoration: underline;
}
.reporting-modal .rpt-link-btn:hover {
    opacity: 0.8;
}
.reporting-modal .rpt-separator {
    color: var(--border-default);
    font-size: 11px;
}

/* ---- Inputs ---- */
.reporting-modal .rpt-input,
.reporting-modal .rpt-select {
    padding: 8px 10px;
    border: 1px solid var(--border-default);
    border-radius: var(--radius-sm);
    font-size: 13px;
    background: var(--bg-surface);
    color: var(--text-primary);
    width: 100%;
    box-sizing: border-box;
}
.reporting-modal .rpt-input:focus,
.reporting-modal .rpt-select:focus {
    outline: none;
    border-color: var(--ford-blue);
    box-shadow: 0 0 0 2px rgba(0, 52, 120, 0.12);
}
.reporting-modal .rpt-input:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* ---- Filter grid ---- */
.reporting-modal .rpt-filters-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: var(--space-2);
}
.reporting-modal .rpt-field label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

/* ---- Hint ---- */
.reporting-modal .rpt-hint {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 4px;
    min-height: 16px;
}

/* ---- Checkboxes ---- */
.reporting-modal .rpt-check-label {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 13px;
    cursor: pointer;
    color: var(--text-primary);
    white-space: nowrap;
}
.reporting-modal .rpt-check-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--ford-blue);
    cursor: pointer;
}

/* ---- Apparatus checkboxes ---- */
.reporting-modal .rpt-apparatus-checks {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-1) var(--space-2);
}

/* ---- Format checkboxes ---- */
.reporting-modal .rpt-format-checks {
    display: flex;
    gap: var(--space-3);
    flex-wrap: wrap;
}

/* ---- Toggle group ---- */
.reporting-modal .rpt-toggle-group {
    display: inline-flex;
    border: 1px solid var(--border-default);
    border-radius: var(--radius-sm);
    overflow: hidden;
}
.reporting-modal .rpt-toggle-btn {
    padding: 6px 14px;
    border: none;
    background: var(--bg-surface);
    color: var(--text-secondary);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.12s;
}
.reporting-modal .rpt-toggle-btn + .rpt-toggle-btn {
    border-left: 1px solid var(--border-default);
}
.reporting-modal .rpt-toggle-btn.active {
    background: var(--ford-blue);
    color: #fff;
}
.reporting-modal .rpt-toggle-btn:focus-visible {
    outline: 2px solid var(--ford-blue);
    outline-offset: -2px;
}

/* ---- Delivery rows ---- */
.reporting-modal .rpt-delivery-options {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}
.reporting-modal .rpt-delivery-row {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}
.reporting-modal .rpt-delivery-input {
    flex: 1;
    max-width: 320px;
}

/* ---- Action buttons ---- */
.reporting-modal .rpt-actions {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
}
.reporting-modal .rpt-btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 18px;
    background: var(--ford-blue);
    color: #fff;
    border: none;
    border-radius: var(--radius-md);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
}
.reporting-modal .rpt-btn-primary:hover { background: #1e40af; }
.reporting-modal .rpt-btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.reporting-modal .rpt-btn-primary:focus-visible {
    outline: 2px solid var(--ford-blue);
    outline-offset: 2px;
}
.reporting-modal .rpt-btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 18px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.15s;
}
.reporting-modal .rpt-btn-secondary:hover {
    background: var(--bg-active);
    border-color: var(--ford-blue);
}
.reporting-modal .rpt-btn-secondary:focus-visible {
    outline: 2px solid var(--ford-blue);
    outline-offset: 2px;
}
.reporting-modal .rpt-btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

/* ---- Danger (delete) ---- */
.reporting-modal .rpt-btn-danger {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 5px 10px;
    background: none;
    border: 1px solid var(--danger);
    border-radius: var(--radius-sm);
    font-size: 11px;
    font-weight: 600;
    color: var(--danger);
    cursor: pointer;
    transition: all 0.15s;
}
.reporting-modal .rpt-btn-danger:hover {
    background: var(--danger);
    color: #fff;
}

/* ---- Tables ---- */
.reporting-modal .rpt-table-wrap {
    overflow-x: auto;
    max-height: 340px;
    overflow-y: auto;
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
}
.reporting-modal .rpt-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
}
.reporting-modal .rpt-table thead {
    position: sticky;
    top: 0;
    z-index: 1;
}
.reporting-modal .rpt-table th {
    padding: 8px 10px;
    text-align: left;
    font-weight: 700;
    font-size: 11px;
    text-transform: uppercase;
    color: var(--text-secondary);
    background: var(--bg-elevated);
    border-bottom: 2px solid var(--border-default);
    white-space: nowrap;
}
.reporting-modal .rpt-table td {
    padding: 7px 10px;
    border-bottom: 1px solid var(--border-light);
    color: var(--text-primary);
    vertical-align: middle;
}
.reporting-modal .rpt-table tbody tr:nth-child(even) {
    background: var(--bg-elevated);
}
.reporting-modal .rpt-table tbody tr:hover {
    background: var(--bg-active);
}
.reporting-modal .rpt-table .rpt-empty {
    text-align: center;
    color: var(--text-secondary);
    padding: 24px 10px;
    font-style: italic;
}

/* ---- Status badges ---- */
.reporting-modal .rpt-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: var(--radius-full);
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.02em;
}
.reporting-modal .rpt-badge-success { background: #dcfce7; color: #166534; }
.reporting-modal .rpt-badge-failed  { background: #fee2e2; color: #991b1b; }
.reporting-modal .rpt-badge-partial { background: #fef9c3; color: #854d0e; }
.reporting-modal .rpt-badge-pending { background: #f1f5f9; color: #475569; }

/* ---- Toggle switch (enable/disable) ---- */
.reporting-modal .rpt-toggle-switch {
    position: relative;
    display: inline-block;
    width: 38px;
    height: 20px;
}
.reporting-modal .rpt-toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.reporting-modal .rpt-toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #9ca3af;
    border-radius: 20px;
    transition: 0.2s;
}
.reporting-modal .rpt-toggle-slider:before {
    content: "";
    position: absolute;
    height: 14px;
    width: 14px;
    left: 3px;
    bottom: 3px;
    background: white;
    border-radius: 50%;
    transition: 0.2s;
}
.reporting-modal .rpt-toggle-switch input:checked + .rpt-toggle-slider {
    background: #16a34a;
}
.reporting-modal .rpt-toggle-switch input:checked + .rpt-toggle-slider:before {
    transform: translateX(18px);
}

/* ---- Dataset cards (Builder tab) ---- */
.reporting-modal .rpt-dataset-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-2);
}
.reporting-modal .rpt-dataset-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: var(--space-3);
    background: var(--bg-elevated);
    border: 2px solid var(--border-default);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-primary);
    transition: all 0.15s;
}
.reporting-modal .rpt-dataset-card:hover {
    border-color: var(--ford-blue);
    background: var(--bg-active);
}
.reporting-modal .rpt-dataset-card.active {
    border-color: var(--ford-blue);
    background: var(--bg-active);
    color: var(--ford-blue);
}

/* ---- Field grid (Builder) ---- */
.reporting-modal .rpt-field-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px var(--space-3);
    max-height: 180px;
    overflow-y: auto;
    padding: var(--space-2);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    background: var(--bg-elevated);
}

/* ---- Group-by / Sort row ---- */
.reporting-modal .rpt-group-by-row,
.reporting-modal .rpt-sort-row {
    display: flex;
    gap: var(--space-2);
    align-items: center;
}
.reporting-modal .rpt-group-by-row .rpt-select {
    flex: 1;
}

/* ---- Agg checks ---- */
.reporting-modal .rpt-agg-checks {
    display: flex;
    gap: var(--space-3);
}

/* ---- Save section ---- */
.reporting-modal .rpt-save-row {
    display: flex;
    gap: var(--space-2);
    align-items: center;
}

/* ---- Expand button ---- */
.reporting-modal .rpt-expand-btn {
    width: 100%;
    justify-content: center;
}

/* ---- History filters ---- */
.reporting-modal .rpt-history-filters {
    display: flex;
    gap: var(--space-2);
    align-items: center;
    flex-wrap: wrap;
}

/* ---- History row actions ---- */
.reporting-modal .rpt-row-actions {
    display: flex;
    gap: 4px;
}
.reporting-modal .rpt-row-btn {
    padding: 4px 8px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-sm);
    font-size: 11px;
    cursor: pointer;
    color: var(--text-primary);
    transition: all 0.12s;
    white-space: nowrap;
}
.reporting-modal .rpt-row-btn:hover {
    background: var(--bg-active);
    border-color: var(--ford-blue);
}

/* ---- Delivery detail expansion ---- */
.reporting-modal .rpt-delivery-detail {
    padding: var(--space-2) var(--space-3);
    background: var(--bg-elevated);
    border-top: 1px dashed var(--border-default);
    font-size: 11px;
    color: var(--text-secondary);
}
.reporting-modal .rpt-delivery-detail table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 4px;
}
.reporting-modal .rpt-delivery-detail th,
.reporting-modal .rpt-delivery-detail td {
    padding: 4px 8px;
    border: 1px solid var(--border-light);
    text-align: left;
    font-size: 11px;
}
.reporting-modal .rpt-delivery-detail th {
    background: var(--bg-active);
}

/* ---- Spinner (inline loading) ---- */
.reporting-modal .rpt-spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid var(--border-default);
    border-top-color: var(--ford-blue);
    border-radius: 50%;
    animation: rpt-spin 0.6s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
}
@keyframes rpt-spin {
    to { transform: rotate(360deg); }
}

/* ---- Analytics tab ---- */
.reporting-modal .analytics-date-row {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}
.reporting-modal .analytics-kpi-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
}
.reporting-modal .analytics-kpi-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    padding: 12px;
    text-align: center;
}
.reporting-modal .analytics-kpi-value {
    font-size: 22px;
    font-weight: 800;
    color: #003478;
    line-height: 1.2;
}
.reporting-modal .analytics-kpi-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-secondary);
    margin-top: 2px;
}
.reporting-modal .analytics-kpi-trend {
    font-size: 11px;
    font-weight: 600;
    margin-top: 4px;
}
.reporting-modal .analytics-kpi-trend.up { color: #dc2626; }
.reporting-modal .analytics-kpi-trend.down { color: #16a34a; }
.reporting-modal .analytics-kpi-trend.neutral { color: var(--text-secondary); }
.reporting-modal .analytics-charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}
.reporting-modal .analytics-chart-panel {
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    padding: 12px;
}
.reporting-modal .analytics-chart-panel.span-2 {
    grid-column: span 2;
}
.reporting-modal .analytics-chart-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--text-secondary);
    margin-bottom: 8px;
}
.reporting-modal .analytics-generate-row {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}

/* ============================================================ */
/* REPORT VIEWER OVERLAY                                        */
/* ============================================================ */
.reporting-modal .rpt-viewer-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-surface);
    z-index: 100;
    display: flex;
    flex-direction: column;
}
.reporting-modal .rpt-viewer-panel {
    display: flex;
    flex-direction: column;
    height: 100%;
}
.reporting-modal .rpt-viewer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 16px;
    background: var(--ford-blue);
    color: white;
    font-weight: 600;
    font-size: 14px;
    flex-shrink: 0;
}
.reporting-modal .rpt-viewer-close {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    line-height: 1;
    padding: 0 4px;
    opacity: 0.8;
    transition: opacity 0.15s;
}
.reporting-modal .rpt-viewer-close:hover {
    opacity: 1;
}
.reporting-modal .rpt-viewer-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    font-size: 13px;
    line-height: 1.6;
    background: #fff;
    color: #1a1a1a;
}
.reporting-modal .rpt-viewer-content table {
    width: 100%;
    border-collapse: collapse;
}
.reporting-modal .rpt-viewer-content th,
.reporting-modal .rpt-viewer-content td {
    padding: 6px 8px;
    border: 1px solid #d1d5db;
    text-align: left;
    font-size: 12px;
}
.reporting-modal .rpt-viewer-content th {
    background: #f3f4f6;
    font-weight: 600;
}
.reporting-modal .rpt-viewer-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-2);
    padding: 10px 16px;
    border-top: 1px solid var(--border-default);
    background: var(--bg-elevated);
    flex-shrink: 0;
    flex-wrap: wrap;
}
.reporting-modal .rpt-viewer-actions-left {
    display: flex;
    gap: 6px;
    align-items: center;
}
.reporting-modal .rpt-viewer-actions-right {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}
.reporting-modal .rpt-viewer-send-group {
    display: flex;
    gap: 4px;
    align-items: center;
}
.reporting-modal .rpt-viewer-input {
    width: 170px;
    padding: 5px 8px;
    font-size: 12px;
}
.reporting-modal .rpt-viewer-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: var(--text-secondary);
    font-size: 14px;
}
</style>

<!-- ===================================================================== -->
<!-- JAVASCRIPT                                                            -->
<!-- ===================================================================== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
window.REPORTING = {

    // ------------------------------------------------------------------ state
    _templates: [],
    _historyCache: [],
    _historyLoaded: false,
    _analyticsLoaded: false,
    _chartInstances: {},
    _activeDataset: 'dailylog',
    _sortDir: 'asc',
    _blotterMode: 'condensed',
    _currentRunId: null,
    _currentRunLinks: {},

    // Canonical field lists per dataset
    _datasetFields: {
        dailylog: [
            'id','timestamp','shift','calltaker','event_type','event_subtype',
            'description','location','unit','status','priority','disposition',
            'narrative','remarks','created_at','updated_at'
        ],
        incidents: [
            'incident_id','incident_number','type','subtype','priority','location',
            'address','cross_street','latitude','longitude','caller_name',
            'caller_phone','calltaker','dispatcher','disposition','narrative',
            'created_at','dispatched_at','enroute_at','arrived_at','cleared_at',
            'units_assigned','status'
        ],
        units: [
            'unit_id','name','station','shift','status','type','personnel_count',
            'response_count','avg_response_time','total_on_scene_time',
            'last_dispatched','utilization_pct'
        ],
        calltaker: [
            'calltaker_id','name','shift','call_count','avg_dispatch_time',
            'disposition_breakdown','remark_count','active_since'
        ]
    },

    // ------------------------------------------------------------------ init
    init() {
        this._initTabs();
        this._setDefaultDates();
        this.loadTemplates();
    },

    // ------------------------------------------------------------------ tabs
    _initTabs() {
        const modal = document.querySelector('.reporting-modal');
        if (!modal) return;
        modal.querySelectorAll('.rpt-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                modal.querySelectorAll('.rpt-tab').forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                });
                modal.querySelectorAll('.rpt-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                tab.setAttribute('aria-selected', 'true');
                const panel = document.getElementById('rpt-panel-' + tab.dataset.tab);
                if (panel) panel.classList.add('active');

                // Lazy-load data
                if (tab.dataset.tab === 'analytics' && !this._analyticsLoaded) {
                    this.loadAnalytics();
                }
                if (tab.dataset.tab === 'history' && !this._historyLoaded) {
                    this.loadHistory();
                }
                if (tab.dataset.tab === 'builder') {
                    this._populateFieldGrid();
                }
            });

            // Keyboard: arrow keys for tab navigation
            tab.addEventListener('keydown', (e) => {
                const tabs = Array.from(modal.querySelectorAll('.rpt-tab'));
                const idx = tabs.indexOf(tab);
                let target = null;
                if (e.key === 'ArrowRight') target = tabs[(idx + 1) % tabs.length];
                if (e.key === 'ArrowLeft') target = tabs[(idx - 1 + tabs.length) % tabs.length];
                if (target) { e.preventDefault(); target.focus(); target.click(); }
            });
        });
    },

    // ------------------------------------------------------------------ date presets
    _setDefaultDates() {
        // Apply "Yesterday to Today" preset by default
        this.onDatePresetChange();
    },

    _dateStr(d) {
        return d.toISOString().slice(0, 10);
    },

    onDatePresetChange() {
        const preset = document.getElementById('rpt-date-preset');
        const startEl = document.getElementById('rpt-date-start');
        const endEl = document.getElementById('rpt-date-end');
        if (!preset || !startEl || !endEl) return;

        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        const val = preset.value;
        let startDate, endDate;

        switch (val) {
            case 'today':
                startDate = today;
                endDate = today;
                break;
            case 'yesterday_today':
                startDate = yesterday;
                endDate = today;
                break;
            case 'last_7':
                startDate = new Date(today);
                startDate.setDate(startDate.getDate() - 6);
                endDate = today;
                break;
            case 'last_30':
                startDate = new Date(today);
                startDate.setDate(startDate.getDate() - 29);
                endDate = today;
                break;
            case 'custom':
                // Don't auto-set -- let the user pick
                return;
        }

        startEl.value = this._dateStr(startDate);
        endEl.value = this._dateStr(endDate);
    },

    // ------------------------------------------------------------------ template change
    onTemplateChange() {
        const sel = document.getElementById('rpt-template-select');
        const desc = document.getElementById('rpt-template-desc');
        if (!sel) return;
        const tpl = this._templates.find(t => t.template_key === sel.value);
        if (desc) desc.textContent = tpl ? tpl.description : '';
    },

    // ------------------------------------------------------------------ mode toggle
    setMode(btn) {
        const container = document.getElementById('rpt-mode-toggle');
        if (!container) return;
        container.querySelectorAll('.rpt-toggle-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        this._blotterMode = btn.dataset.mode;
    },

    // ------------------------------------------------------------------ sort toggle
    setSortDir(btn) {
        const container = document.getElementById('rpt-sort-toggle');
        if (!container) return;
        container.querySelectorAll('.rpt-toggle-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        this._sortDir = btn.dataset.sort;
    },

    // ------------------------------------------------------------------ dataset selection (builder)
    selectDataset(card) {
        document.querySelectorAll('.rpt-dataset-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        this._activeDataset = card.dataset.dataset;
        this._populateFieldGrid();
    },

    // ------------------------------------------------------------------ apparatus helpers
    selectAllApparatus() {
        document.querySelectorAll('#rpt-apparatus-checks input[type="checkbox"]').forEach(cb => { cb.checked = true; });
    },

    clearAllApparatus() {
        document.querySelectorAll('#rpt-apparatus-checks input[type="checkbox"]').forEach(cb => { cb.checked = false; });
    },

    // ---- populate builder field grid ----
    _populateFieldGrid() {
        const grid = document.getElementById('rpt-field-grid');
        if (!grid) return;
        const fields = this._datasetFields[this._activeDataset] || [];
        grid.innerHTML = fields.map(f =>
            '<label class="rpt-check-label"><input type="checkbox" name="rpt-builder-field" value="' + f + '" checked> ' + f + '</label>'
        ).join('');

        // Also update group-by / sort dropdowns
        const opts = '<option value="">-- None --</option>' +
            fields.map(f => '<option value="' + f + '">' + f + '</option>').join('');
        ['rpt-group-by-1','rpt-group-by-2','rpt-sort-field'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = opts;
        });
    },

    // ------------------------------------------------------------------ helpers
    _getSelectedFormats() {
        return Array.from(document.querySelectorAll('input[name="rpt-format"]:checked'))
            .map(cb => cb.value);
    },

    _getRunFilters() {
        const apparatus = Array.from(
            document.querySelectorAll('#rpt-apparatus-checks input:checked')
        ).map(cb => cb.value);
        return {
            date_from: document.getElementById('rpt-date-start')?.value || '',
            date_to: document.getElementById('rpt-date-end')?.value || '',
            time_from: document.getElementById('rpt-time-from')?.value || '',
            time_to: document.getElementById('rpt-time-to')?.value || '',
            shift: document.getElementById('rpt-shift-select')?.value || '',
            event_type: document.getElementById('rpt-event-type')?.value || '',
            calltaker: document.getElementById('rpt-calltaker')?.value || '',
            status: document.getElementById('rpt-status-filter')?.value || '',
            units: apparatus,
            mode: this._blotterMode,
        };
    },

    _statusBadge(status) {
        const cls = {
            success: 'rpt-badge-success', completed: 'rpt-badge-success',
            failed: 'rpt-badge-failed', error: 'rpt-badge-failed',
            partial: 'rpt-badge-partial',
            pending: 'rpt-badge-pending', running: 'rpt-badge-pending',
        }[status] || 'rpt-badge-pending';
        return '<span class="rpt-badge ' + cls + '">' + this._escHtml(status || 'unknown') + '</span>';
    },

    _escHtml(str) {
        if (!str) return '';
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    },

    _fmtDate(isoStr) {
        if (!isoStr) return '--';
        try {
            const d = new Date(isoStr);
            if (isNaN(d.getTime())) return isoStr;
            return d.toLocaleString(undefined, {
                month: 'short', day: 'numeric', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        } catch (_) {
            return isoStr;
        }
    },

    // ------------------------------------------------------------------ API: templates
    async loadTemplates() {
        try {
            let templates = [];
            try {
                const res = await fetch('/api/reporting/templates');
                if (res.ok) {
                    const data = await res.json();
                    templates = data.templates || [];
                }
            } catch (_) {}

            // Fallback: try legacy endpoint
            if (!templates.length) {
                try {
                    const res2 = await fetch('/api/v2/reports/templates');
                    if (res2.ok) {
                        const data2 = await res2.json();
                        templates = data2.templates || data2 || [];
                    }
                } catch (_) {}
            }

            // Fallback: built-in defaults
            if (!templates.length) {
                templates = [
                    { template_key: 'blotter', name: 'Blotter / Daily Log', description: 'Chronological list of events for a shift or date range.' },
                    { template_key: 'incident_summary', name: 'Incident Summary', description: 'Full incident details: type, location, timestamps, units.' },
                    { template_key: 'shift_handoff', name: 'Shift Handoff Report', description: 'Open incidents, pending items, notes for incoming shift.' },
                    { template_key: 'incident_detail', name: 'Incident Detail (NFIRS)', description: 'Full NFIRS-style report with narrative, units, timeline, losses.' },
                    { template_key: 'open_incidents', name: 'Open / Pending Incidents', description: 'Currently active incidents needing resolution.' },
                    { template_key: 'unit_activity', name: 'Unit Activity Summary', description: 'Call counts and time per apparatus.' },
                    { template_key: 'unit_utilization', name: 'Unit Utilization Report', description: 'Time dispatched vs available per unit.' },
                    { template_key: 'unit_response_stats', name: 'Unit Response Stats', description: 'Response time metrics per unit.' },
                    { template_key: 'response_time_analysis', name: 'Response Time Analysis', description: 'Dispatch-to-arrival breakdown with trends.' },
                    { template_key: 'response_compliance', name: 'Response-Time Compliance', description: 'Pass/fail against response time thresholds.' },
                    { template_key: 'monthly_summary', name: 'Monthly Summary', description: 'Month-by-month totals and comparisons.' },
                    { template_key: 'calltaker_stats', name: 'Calltaker Stats', description: 'Call counts and performance per calltaker.' },
                    { template_key: 'personnel_activity', name: 'Personnel Activity', description: 'Incidents and log entries per person.' },
                    { template_key: 'shift_workload', name: 'Shift Workload Summary', description: 'Workload distribution across shifts.' },
                    { template_key: 'incident_type_breakdown', name: 'Incident Type Breakdown', description: 'Distribution of incidents by type.' },
                    { template_key: 'location_hotspot', name: 'Location Hotspot Report', description: 'Locations with the most incidents.' },
                    { template_key: 'false_alarm', name: 'False Alarm Report', description: 'False alarm patterns and frequency.' },
                    { template_key: 'mutual_aid', name: 'Mutual Aid Given/Received', description: 'External assistance tracking.' },
                    { template_key: 'issue_tracking', name: 'Issue Tracking (OSHA)', description: 'Flagged issues for OSHA compliance.' },
                    { template_key: 'training_log', name: 'Training / Drill Log', description: 'Training, drills, exercises from daily log.' },
                ];
            }

            this._templates = templates;
            this._renderTemplateSelects(templates);
        } catch (e) {
            console.error('[REPORTING] loadTemplates error:', e);
            window.TOAST?.error?.('Failed to load report templates');
        }
    },

    _renderTemplateSelects(templates) {
        const options = '<option value="">-- Select template --</option>' +
            templates.map(t =>
                '<option value="' + this._escHtml(t.template_key) + '">' + this._escHtml(t.name) + '</option>'
            ).join('');

        // Run-tab template select
        const runSel = document.getElementById('rpt-template-select');
        if (runSel) runSel.innerHTML = options;

        // History-tab template filter
        const histSel = document.getElementById('rpt-hist-template-filter');
        if (histSel) {
            histSel.innerHTML = '<option value="">All Templates</option>' +
                templates.map(t =>
                    '<option value="' + this._escHtml(t.template_key) + '">' + this._escHtml(t.name) + '</option>'
                ).join('');
        }
    },

    // ------------------------------------------------------------------ API: run report
    async runReport() {
        const templateKey = document.getElementById('rpt-template-select')?.value;
        if (!templateKey) {
            window.TOAST?.error?.('Select a report template');
            return;
        }

        const formats = this._getSelectedFormats();
        if (!formats.length) {
            window.TOAST?.error?.('Select at least one output format');
            return;
        }

        const filters = this._getRunFilters();

        const payload = {
            template_key: templateKey,
            title: (this._templates.find(t => t.template_key === templateKey)?.name || templateKey) +
                   ' - ' + (filters.date_from || 'today'),
            filters: filters,
            formats: formats,
        };

        window.TOAST?.info?.('Running report...');

        try {
            const res = await fetch('/api/reporting/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const data = await res.json();

            if (data.ok) {
                window.TOAST?.success?.(data.message || 'Report completed');
                this._currentRunId = data.run_id;
                this._currentRunLinks = data.links || {};
                this._historyLoaded = false;

                // Open the viewer with the HTML content
                this._openViewerForRun(data.run_id, data.links);
            } else {
                window.TOAST?.error?.(data.error || 'Report failed');
            }
        } catch (e) {
            console.error('[REPORTING] runReport error:', e);
            window.TOAST?.error?.('Error: ' + e.message);
        }
    },

    // ------------------------------------------------------------------ API: preview
    async previewReport() {
        const templateKey = document.getElementById('rpt-template-select')?.value;
        if (!templateKey) {
            window.TOAST?.error?.('Select a report template');
            return;
        }

        const filters = this._getRunFilters();
        const params = new URLSearchParams({
            template_key: templateKey,
            shift: filters.shift || '',
            date_from: filters.date_from || '',
            date_to: filters.date_to || '',
        });

        // Show viewer overlay in loading state
        this._currentRunId = null;
        this._currentRunLinks = {};
        this._showViewer('Preview: ' + (this._templates.find(t => t.template_key === templateKey)?.name || templateKey));
        const content = document.getElementById('rpt-viewer-content');
        if (content) content.innerHTML = '<div class="rpt-viewer-loading"><span class="rpt-spinner"></span> Loading preview...</div>';

        try {
            const res = await fetch('/api/reporting/preview?' + params.toString());
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const html = await res.text();
            if (content) content.innerHTML = html;
        } catch (e) {
            if (content) content.innerHTML = '<div style="color:var(--danger);padding:20px;">Failed to load preview: ' + this._escHtml(e.message) + '</div>';
        }
    },

    // ------------------------------------------------------------------ Report Viewer
    _showViewer(title) {
        const overlay = document.getElementById('rpt-viewer-overlay');
        const titleEl = document.getElementById('rpt-viewer-title');
        if (overlay) overlay.style.display = 'flex';
        if (titleEl) titleEl.textContent = title || 'Report Viewer';
    },

    closeViewer() {
        const overlay = document.getElementById('rpt-viewer-overlay');
        if (overlay) overlay.style.display = 'none';
        const content = document.getElementById('rpt-viewer-content');
        if (content) content.innerHTML = '';
        this._currentRunId = null;
        this._currentRunLinks = {};
    },

    async _openViewerForRun(runId, links) {
        const tpl = document.getElementById('rpt-template-select');
        const tplName = tpl ? (tpl.options[tpl.selectedIndex]?.text || '') : '';
        this._showViewer(tplName || 'Report #' + runId);

        const content = document.getElementById('rpt-viewer-content');
        if (!content) return;
        content.innerHTML = '<div class="rpt-viewer-loading"><span class="rpt-spinner"></span> Loading report...</div>';

        // Try to load the HTML version of the report
        if (links && links.html) {
            try {
                const res = await fetch(links.html);
                if (res.ok) {
                    content.innerHTML = await res.text();
                    return;
                }
            } catch (_) {}
        }

        // Fallback: fetch run detail and use links from there
        try {
            const res = await fetch('/api/reporting/run/' + runId);
            if (res.ok) {
                const data = await res.json();
                this._currentRunLinks = data.download_links || {};
                if (data.download_links && data.download_links.html) {
                    try {
                        const htmlRes = await fetch(data.download_links.html);
                        if (htmlRes.ok) {
                            content.innerHTML = await htmlRes.text();
                            return;
                        }
                    } catch (_) {}
                }
                // Show summary if no HTML
                const run = data.run || {};
                content.innerHTML = '<div style="padding:20px;"><h3>Report #' + runId + ' - ' + this._escHtml(run.title || '') + '</h3>' +
                    '<p>Status: ' + this._statusBadge(run.status) + '</p>' +
                    '<p>Generated at: ' + this._escHtml(run.created_at || '') + '</p>' +
                    (run.summary_text ? '<pre style="white-space:pre-wrap;font-size:12px;">' + this._escHtml(run.summary_text) + '</pre>' : '') +
                    '</div>';
            } else {
                content.innerHTML = '<div style="padding:20px;color:var(--danger);">Could not load report details.</div>';
            }
        } catch (e) {
            content.innerHTML = '<div style="padding:20px;color:var(--danger);">Error loading report: ' + this._escHtml(e.message) + '</div>';
        }
    },

    viewerDownload(format) {
        if (!this._currentRunId) {
            window.TOAST?.error?.('No report run available for download');
            return;
        }
        // If we have a direct link, use it
        if (this._currentRunLinks && this._currentRunLinks[format]) {
            window.open(this._currentRunLinks[format], '_blank');
            return;
        }
        // Fallback: try the legacy download endpoint
        window.open('/api/reporting/run/' + this._currentRunId + '?format=' + encodeURIComponent(format), '_blank');
    },

    async viewerSendEmail() {
        const email = document.getElementById('rpt-viewer-email')?.value?.trim();
        if (!email) {
            window.TOAST?.error?.('Enter an email address');
            return;
        }
        if (!this._currentRunId) {
            window.TOAST?.error?.('No report run available to deliver');
            return;
        }

        window.TOAST?.info?.('Sending email...');
        try {
            const res = await fetch('/api/reporting/deliver', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    report_run_id: this._currentRunId,
                    channels: [{ channel: 'email', destination: email }]
                }),
            });
            const data = await res.json();
            if (data.ok) {
                window.TOAST?.success?.('Email sent to ' + email);
                document.getElementById('rpt-viewer-email').value = '';
            } else {
                window.TOAST?.error?.(data.error || 'Email delivery failed');
            }
        } catch (e) {
            window.TOAST?.error?.('Error: ' + e.message);
        }
    },

    async viewerSendSMS() {
        const phone = document.getElementById('rpt-viewer-sms')?.value?.trim();
        if (!phone) {
            window.TOAST?.error?.('Enter a phone number');
            return;
        }
        if (!this._currentRunId) {
            window.TOAST?.error?.('No report run available to deliver');
            return;
        }

        window.TOAST?.info?.('Sending SMS...');
        try {
            const res = await fetch('/api/reporting/deliver', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    report_run_id: this._currentRunId,
                    channels: [{ channel: 'sms', destination: phone }]
                }),
            });
            const data = await res.json();
            if (data.ok) {
                window.TOAST?.success?.('SMS sent to ' + phone);
                document.getElementById('rpt-viewer-sms').value = '';
            } else {
                window.TOAST?.error?.(data.error || 'SMS delivery failed');
            }
        } catch (e) {
            window.TOAST?.error?.('Error: ' + e.message);
        }
    },

    // ------------------------------------------------------------------ API: history
    async loadHistory() {
        const tbody = document.getElementById('rpt-history-tbody');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="7" class="rpt-empty"><span class="rpt-spinner"></span> Loading...</td></tr>';

        const templateFilter = document.getElementById('rpt-hist-template-filter')?.value || '';
        const statusFilter = document.getElementById('rpt-hist-status-filter')?.value || '';

        const params = new URLSearchParams({ limit: '50' });
        if (templateFilter) params.set('template_key', templateFilter);
        if (statusFilter) params.set('status', statusFilter);

        try {
            const res = await fetch('/api/reporting/history?' + params.toString());
            const data = await res.json();
            const runs = data.history || [];
            this._historyCache = runs;

            this._renderHistoryTable(runs);
            this._historyLoaded = true;
        } catch (e) {
            console.error('[REPORTING] loadHistory error:', e);
            // Try legacy endpoint
            try {
                const res2 = await fetch('/api/v2/reports/history?limit=50');
                const data2 = await res2.json();
                const runs2 = data2.history || [];
                this._historyCache = runs2;
                this._renderHistoryTable(runs2);
                this._historyLoaded = true;
            } catch (e2) {
                tbody.innerHTML = '<tr><td colspan="7" class="rpt-empty" style="color:var(--danger);">Failed to load history: ' + this._escHtml(e.message) + '</td></tr>';
            }
        }
    },

    _renderHistoryTable(runs) {
        const tbody = document.getElementById('rpt-history-tbody');
        if (!tbody) return;

        if (!runs.length) {
            tbody.innerHTML = '<tr><td colspan="7" class="rpt-empty">No report history found.</td></tr>';
            return;
        }

        tbody.innerHTML = runs.map(r => {
            const filters = r.filters || {};
            const filtersObj = typeof filters === 'string' ? this._jsonParse(filters) : filters;
            const dateFrom = filtersObj.date_from || filtersObj.start_date || '';
            const dateTo = filtersObj.date_to || filtersObj.end_date || '';
            const dateRange = dateFrom + (dateTo ? ' .. ' + dateTo : '');
            const formats = r.formats || r.format || [];
            const fmtStr = Array.isArray(formats) ? formats.join(', ') : String(formats);
            const status = r.status || 'pending';
            const created = r.created_at || r.started_at || '';
            const id = r.id || r.run_id || 0;

            return '<tr data-run-id="' + id + '">' +
                '<td>' + this._escHtml(r.title || r.report_type || '--') + '</td>' +
                '<td>' + this._escHtml(r.template_key || r.report_type || '--') + '</td>' +
                '<td>' + this._escHtml(dateRange || '--') + '</td>' +
                '<td>' + this._escHtml(fmtStr || 'html') + '</td>' +
                '<td>' + this._statusBadge(status) + '</td>' +
                '<td>' + this._escHtml(this._fmtDate(created)) + '</td>' +
                '<td class="rpt-row-actions">' +
                    '<button class="rpt-row-btn" onclick="REPORTING.viewHistoryRun(' + id + ')" title="View">View</button>' +
                    '<button class="rpt-row-btn" onclick="REPORTING.downloadHistoryArtifact(' + id + ',\'pdf\')" title="Download PDF">PDF</button>' +
                    '<button class="rpt-row-btn" onclick="REPORTING.downloadHistoryArtifact(' + id + ',\'csv\')" title="Download CSV">CSV</button>' +
                    '<button class="rpt-row-btn" onclick="REPORTING.resendHistoryRun(' + id + ')" title="Re-send">Re-send</button>' +
                '</td>' +
                '</tr>';
        }).join('');
    },

    filterHistory() {
        const search = (document.getElementById('rpt-hist-search')?.value || '').toLowerCase().trim();
        if (!search) {
            this._renderHistoryTable(this._historyCache);
            return;
        }
        const filtered = this._historyCache.filter(r => {
            const title = (r.title || r.report_type || '').toLowerCase();
            const tpl = (r.template_key || '').toLowerCase();
            return title.includes(search) || tpl.includes(search);
        });
        this._renderHistoryTable(filtered);
    },

    async viewHistoryRun(runId) {
        this._currentRunId = runId;
        this._currentRunLinks = {};
        this._showViewer('Report #' + runId);
        const content = document.getElementById('rpt-viewer-content');
        if (content) content.innerHTML = '<div class="rpt-viewer-loading"><span class="rpt-spinner"></span> Loading report...</div>';

        try {
            const res = await fetch('/api/reporting/run/' + runId);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            this._currentRunLinks = data.download_links || {};

            // Try to load HTML report
            if (data.download_links && data.download_links.html) {
                try {
                    const htmlRes = await fetch(data.download_links.html);
                    if (htmlRes.ok) {
                        if (content) content.innerHTML = await htmlRes.text();
                        return;
                    }
                } catch (_) {}
            }

            // Fallback: show summary
            const run = data.run || {};
            if (content) {
                content.innerHTML = '<div style="padding:20px;">' +
                    '<h3>' + this._escHtml(run.title || 'Report #' + runId) + '</h3>' +
                    '<p>Status: ' + this._statusBadge(run.status) + '</p>' +
                    '<p>Created: ' + this._escHtml(this._fmtDate(run.created_at)) + '</p>' +
                    (run.summary_text ? '<pre style="white-space:pre-wrap;font-size:12px;margin-top:12px;">' + this._escHtml(run.summary_text) + '</pre>' : '<p>No HTML artifact available for this run.</p>') +
                    '</div>';
            }
        } catch (e) {
            if (content) content.innerHTML = '<div style="padding:20px;color:var(--danger);">Failed to load report: ' + this._escHtml(e.message) + '</div>';
        }
    },

    async downloadHistoryArtifact(runId, format) {
        try {
            const res = await fetch('/api/reporting/run/' + runId);
            if (res.ok) {
                const data = await res.json();
                if (data.download_links && data.download_links[format]) {
                    window.open(data.download_links[format], '_blank');
                    return;
                }
            }
        } catch (_) {}
        // Fallback: try legacy
        window.open('/api/v2/reports/history/' + runId + '/download?format=' + encodeURIComponent(format), '_blank');
    },

    async resendHistoryRun(runId) {
        // Open viewer with delivery options
        this._currentRunId = runId;
        await this.viewHistoryRun(runId);
        window.TOAST?.info?.('Use the email/SMS fields below the report to deliver');
    },

    // ------------------------------------------------------------------ Analytics Tab
    _getAnalyticsDateRange() {
        const preset = document.getElementById('analytics-preset')?.value || '30d';
        const today = new Date();
        let from, to;
        to = new Date(today);

        switch (preset) {
            case '7d':
                from = new Date(today); from.setDate(from.getDate() - 6); break;
            case '30d':
                from = new Date(today); from.setDate(from.getDate() - 29); break;
            case '90d':
                from = new Date(today); from.setDate(from.getDate() - 89); break;
            case 'mtd':
                from = new Date(today.getFullYear(), today.getMonth(), 1); break;
            case 'ytd':
                from = new Date(today.getFullYear(), 0, 1); break;
            case 'custom':
                return {
                    from: document.getElementById('analytics-date-from')?.value || this._dateStr(new Date(today.setDate(today.getDate() - 29))),
                    to: document.getElementById('analytics-date-to')?.value || this._dateStr(new Date())
                };
        }
        const result = { from: this._dateStr(from), to: this._dateStr(to) };
        const fromEl = document.getElementById('analytics-date-from');
        const toEl = document.getElementById('analytics-date-to');
        if (fromEl) fromEl.value = result.from;
        if (toEl) toEl.value = result.to;
        return result;
    },

    onAnalyticsPresetChange() {
        this._getAnalyticsDateRange();
    },

    async loadAnalytics() {
        const range = this._getAnalyticsDateRange();
        this._analyticsLoaded = true;

        // Try to fetch analytics data from server
        try {
            const params = new URLSearchParams({ date_from: range.from, date_to: range.to });
            const res = await fetch('/api/reporting/preview?template_key=executive_summary&' + params.toString());
            if (!res.ok) throw new Error('HTTP ' + res.status);

            // Parse KPI data from server-generated report
            // We'll use the analytics API or extract from executive summary
            const analyticsRes = await fetch('/api/analytics?' + params.toString()).catch(() => null);
            let kpis = null;
            if (analyticsRes && analyticsRes.ok) {
                kpis = await analyticsRes.json();
            }

            // Also fetch raw data for charts
            const incRes = await fetch('/api/reporting/preview?template_key=incident_analytics&' + params.toString()).catch(() => null);

            this._renderAnalyticsKPIs(kpis, range);
            this._renderAnalyticsCharts(range);
        } catch (e) {
            console.warn('[REPORTING] Analytics load error:', e);
            // Still render charts with whatever data we can get
            this._renderAnalyticsKPIs(null, range);
            this._renderAnalyticsCharts(range);
        }
    },

    _renderAnalyticsKPIs(data, range) {
        // Fetch incident count from dailylog for KPIs
        const setKPI = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
        const setTrend = (id, val, cls) => {
            const el = document.getElementById(id);
            if (el) { el.textContent = val; el.className = 'analytics-kpi-trend ' + cls; }
        };

        if (data && data.kpis) {
            const k = data.kpis;
            setKPI('kpi-total-incidents', k.total_incidents || '--');
            setKPI('kpi-avg-response', k.avg_response_time || '--');
            setKPI('kpi-p90-response', k.p90_response_time || '--');
            setKPI('kpi-compliance', k.compliance_pct ? (k.compliance_pct + '%') : '--');
            setKPI('kpi-active-units', k.active_units || '--');
        } else {
            // Fetch from run to get KPIs
            fetch('/api/reporting/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    template_key: 'executive_summary',
                    filters: { date_from: range.from, date_to: range.to },
                    formats: [],
                    title: '__analytics_kpi_fetch__'
                })
            }).then(r => r.json()).then(d => {
                if (d.ok && d.kpis) {
                    const k = d.kpis;
                    setKPI('kpi-total-incidents', k.total_incidents ?? '--');
                    setKPI('kpi-avg-response', k.avg_response_time ? (k.avg_response_time + ' min') : '--');
                    setKPI('kpi-p90-response', k.p90_response_time ? (k.p90_response_time + ' min') : '--');
                    setKPI('kpi-compliance', k.compliance_pct != null ? (k.compliance_pct + '%') : '--');
                    setKPI('kpi-active-units', k.active_units ?? '--');

                    if (k.delta) {
                        const d = k.delta;
                        if (d.incidents != null) setTrend('kpi-trend-incidents',
                            (d.incidents >= 0 ? '+' : '') + d.incidents + '%',
                            d.incidents > 5 ? 'up' : d.incidents < -5 ? 'down' : 'neutral');
                    }
                }
            }).catch(() => {});
        }
    },

    _renderAnalyticsCharts(range) {
        if (typeof Chart === 'undefined') {
            console.warn('[REPORTING] Chart.js not loaded yet');
            setTimeout(() => this._renderAnalyticsCharts(range), 500);
            return;
        }

        const FORD_BLUE = '#003478';
        const FORD_LIGHT = '#4a7cc9';
        const FIRE_RED = '#dc2626';
        const CHART_COLORS = [FORD_BLUE, FIRE_RED, '#f59e0b', '#16a34a', '#8b5cf6', '#06b6d4', '#ec4899', '#6366f1'];

        // Destroy previous chart instances
        Object.values(this._chartInstances).forEach(c => { try { c.destroy(); } catch(_){} });
        this._chartInstances = {};

        // Fetch data for charts via the run API
        fetch('/api/reporting/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                template_key: 'incident_analytics',
                filters: { date_from: range.from, date_to: range.to },
                formats: [],
                title: '__analytics_chart_fetch__'
            })
        }).then(r => r.json()).then(result => {
            const cd = result.chart_data || {};

            // 1. Incident Trend (line chart)
            const trendCtx = document.getElementById('chart-incident-trend');
            if (trendCtx && cd.daily_trend) {
                this._chartInstances.trend = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: cd.daily_trend.labels || [],
                        datasets: [{
                            label: 'Incidents',
                            data: cd.daily_trend.values || [],
                            borderColor: FORD_BLUE,
                            backgroundColor: FORD_BLUE + '20',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { maxTicksLimit: 10, font: { size: 10 } } },
                            y: { beginAtZero: true, ticks: { font: { size: 10 } } }
                        }
                    }
                });
            }

            // 2. Type Breakdown (donut)
            const typeCtx = document.getElementById('chart-type-breakdown');
            if (typeCtx && cd.type_breakdown) {
                this._chartInstances.typeBreak = new Chart(typeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: cd.type_breakdown.labels || [],
                        datasets: [{
                            data: cd.type_breakdown.values || [],
                            backgroundColor: CHART_COLORS.slice(0, (cd.type_breakdown.labels || []).length),
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { font: { size: 10 }, boxWidth: 12 } }
                        }
                    }
                });
            }

            // 3. Hourly Pattern (bar)
            const hourCtx = document.getElementById('chart-hourly-pattern');
            if (hourCtx && cd.hourly_pattern) {
                this._chartInstances.hourly = new Chart(hourCtx, {
                    type: 'bar',
                    data: {
                        labels: cd.hourly_pattern.labels || [],
                        datasets: [{
                            label: 'Incidents',
                            data: cd.hourly_pattern.values || [],
                            backgroundColor: FORD_BLUE + 'cc',
                            borderRadius: 3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { font: { size: 9 } } },
                            y: { beginAtZero: true, ticks: { font: { size: 10 } } }
                        }
                    }
                });
            }

            // 4. Unit Utilization (horizontal bar) - fetch from unit_performance
            fetch('/api/reporting/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    template_key: 'unit_performance',
                    filters: { date_from: range.from, date_to: range.to },
                    formats: [],
                    title: '__analytics_unit_fetch__'
                })
            }).then(r => r.json()).then(uResult => {
                const ucd = uResult.chart_data || {};
                const utilCtx = document.getElementById('chart-unit-utilization');
                if (utilCtx && ucd.utilization) {
                    this._chartInstances.util = new Chart(utilCtx, {
                        type: 'bar',
                        data: {
                            labels: ucd.utilization.labels || [],
                            datasets: [{
                                label: 'Utilization %',
                                data: ucd.utilization.values || [],
                                backgroundColor: FORD_LIGHT + 'cc',
                                borderRadius: 3,
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { beginAtZero: true, max: 100, ticks: { font: { size: 10 } } },
                                y: { ticks: { font: { size: 10 } } }
                            }
                        }
                    });
                }
            }).catch(() => {});

        }).catch(e => {
            console.warn('[REPORTING] Chart data fetch error:', e);
        });
    },

    async generateAnalyticsReport() {
        const templateKey = document.getElementById('analytics-template-select')?.value || 'executive_summary';
        const format = document.getElementById('analytics-format-select')?.value || 'html';
        const range = this._getAnalyticsDateRange();

        const tplName = document.getElementById('analytics-template-select')?.selectedOptions[0]?.text || templateKey;
        window.TOAST?.info?.('Generating ' + tplName + '...');

        try {
            const res = await fetch('/api/reporting/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    template_key: templateKey,
                    filters: { date_from: range.from, date_to: range.to },
                    formats: [format],
                    title: tplName + ' - ' + range.from + ' to ' + range.to,
                })
            });
            const data = await res.json();
            if (data.ok) {
                window.TOAST?.success?.(data.message || 'Report generated');
                this._currentRunId = data.run_id;
                this._currentRunLinks = data.links || {};
                this._historyLoaded = false;
                this._openViewerForRun(data.run_id, data.links);
            } else {
                window.TOAST?.error?.(data.error || 'Report generation failed');
            }
        } catch (e) {
            window.TOAST?.error?.('Error: ' + e.message);
        }
    },

    async previewAnalyticsReport() {
        const templateKey = document.getElementById('analytics-template-select')?.value || 'executive_summary';
        const range = this._getAnalyticsDateRange();
        const tplName = document.getElementById('analytics-template-select')?.selectedOptions[0]?.text || templateKey;

        this._currentRunId = null;
        this._currentRunLinks = {};
        this._showViewer('Preview: ' + tplName);
        const content = document.getElementById('rpt-viewer-content');
        if (content) content.innerHTML = '<div class="rpt-viewer-loading"><span class="rpt-spinner"></span> Loading preview...</div>';

        try {
            const params = new URLSearchParams({
                template_key: templateKey,
                date_from: range.from,
                date_to: range.to,
            });
            const res = await fetch('/api/reporting/preview?' + params.toString());
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const html = await res.text();
            if (content) content.innerHTML = html;
        } catch (e) {
            if (content) content.innerHTML = '<div style="color:var(--danger);padding:20px;">Failed to load preview: ' + this._escHtml(e.message) + '</div>';
        }
    },

    _jsonParse(str) {
        try { return JSON.parse(str); } catch (_) { return {}; }
    },

    // ------------------------------------------------------------------ API: save custom template (builder)
    async saveCustomTemplate() {
        const name = document.getElementById('rpt-new-template-name')?.value?.trim();
        if (!name) { window.TOAST?.error?.('Enter a template name'); return; }

        const key = name.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/(^_|_$)/g, '');

        const selectedFields = Array.from(
            document.querySelectorAll('input[name="rpt-builder-field"]:checked')
        ).map(cb => cb.value);

        const groupBy = [
            document.getElementById('rpt-group-by-1')?.value,
            document.getElementById('rpt-group-by-2')?.value,
        ].filter(Boolean);

        const sortField = document.getElementById('rpt-sort-field')?.value || '';
        const aggregations = Array.from(
            document.querySelectorAll('input[name="rpt-agg"]:checked')
        ).map(cb => cb.value);

        const config = {
            dataset: this._activeDataset,
            fields: selectedFields,
            group_by: groupBy,
            sort_by: sortField,
            sort_dir: this._sortDir,
            aggregations: aggregations,
        };

        const payload = {
            name: name,
            template_key: key,
            description: 'Custom report on ' + this._activeDataset + ' dataset.',
            default_config: config,
        };

        try {
            const res = await fetch('/api/reporting/templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (res.ok) {
                const data = await res.json();
                window.TOAST?.success?.('Template saved: ' + name);
                document.getElementById('rpt-new-template-name').value = '';
                this.loadTemplates();
            } else {
                const err = await res.json().catch(function() { return {}; });
                window.TOAST?.error?.(err.detail || err.error || 'Failed to save template');
            }
        } catch (e) {
            window.TOAST?.error?.('Error: ' + e.message);
        }
    },

};

// Initialize when modal opens
setTimeout(function() { REPORTING.init(); }, 50);
</script>
