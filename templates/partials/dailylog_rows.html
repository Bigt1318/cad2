{# ============================================================
   FILE: templates/partials/dailylog_rows.html
   FORD-CAD — DAILY LOG ROWS (PARTIAL)
   Canon: ONLY DAILYLOG journal entries (dl.action='DAILYLOG')
   Columns: DL# | Timestamp | Subtype | Unit | Incident | Details
   FIXES:
     • Always show an incident reference if present (even if join fails)
     • Only show IAW/Hist/Reopen when a resolved internal incident_id exists
     • Remove dependency on row.label (DailyLog subtype is event_type)
     • Added dl_number column (YYYY-NNNN format)
   ============================================================ #}

{% if rows and rows|length %}
  {% for row in rows %}
    <tr>
      <td class="dl-num">{{ row.dl_number or "" }}</td>

      <td class="ts">{{ row.timestamp or "" }}</td>

      <td>{{ row.event_type or "OTHER" }}</td>

      <td>{{ row.unit_id or "" }}</td>

      <td>
        {# Prefer resolved incident_number, then resolved incident_id, then raw stored reference #}
        {% set display_incident = row.incident_number or row.incident_id or row.incident_ref or row.incident_id_raw or "" %}

        {% if display_incident %}
          <div class="dl-incident-cell">
            <span class="dl-incident-id">{{ display_incident }}</span>

            {# Buttons ONLY if we have a real internal incident_id #}
            {% if row.incident_id %}
              <button class="dl-mini-btn" type="button"
                      data-action="dailylog-open-iaw"
                      data-incident-id="{{ row.incident_id }}">
                IAW
              </button>

              <button class="dl-mini-btn" type="button"
                      data-action="dailylog-open-history"
                      data-incident-id="{{ row.incident_id }}">
                Hist
              </button>

              {% if (row.incident_status or "")|upper == "CLOSED" %}
                <button class="dl-mini-btn dl-mini-danger" type="button"
                        data-action="incident-reopen"
                        data-incident-id="{{ row.incident_id }}">
                  Reopen
                </button>
              {% endif %}
            {% endif %}
          </div>
        {% else %}
          —
        {% endif %}
      </td>

      <td>{{ row.details or "" }}</td>
    </tr>
  {% endfor %}
{% else %}
  <tr>
    <td colspan="6" class="log-empty">No Daily Log entries.</td>
  </tr>
{% endif %}
